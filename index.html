<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ç®±åº­ã‚²ãƒ¼ãƒ </title>
  <style>
    body { font-family: sans-serif; }
    table { border-collapse: collapse; }
  td {
    width: 22px;
    height: 22px;
    border: 1px solid #aaa;
    text-align: center;
    cursor: pointer;
  }
  .selected {
    outline: 2px solid gray;
    outline-offset: -1px;
  }
    .sea { background-color: #aaf; }
    .plain { background-color: #efe; }
    .waste { background-color: #ddd; }
    .forest { background-color: #4a9; }
    .farm { background-color: #efe; }
    .house { background-color: #efe; }
    .factory { background-color: #efe; }
    .gun { background-color: #4a9; }
    .port { background-color: #aaf; }
    .defenseFacility { background-color: #f9d; } /* é˜²è¡›æ–½è¨­ã®è‰²ã‚’è¿½åŠ  */
    .enhancedFarm { background-color: #efe; } /* å¼·åŒ–è¾²å ´ã‚‚åŒã˜è‰² */
    .enhancedFactory { background-color: #efe; } /* å¼·åŒ–å·¥å ´ã‚‚åŒã˜è‰² */
    .Monument { background-color: #efe; }
    .warship { background-color: #aaf; }
    .warship-dispatched { background-color: #aaf; color: #fff;} /* æ´¾é£ä¸­ã®è»è‰¦ */
    .warship-wreckage { background-color: #aaf; color: #fff; } /* è»è‰¦ã®æ®‹éª¸ã®è‰² */

  .selected {
    border: 2px solid gray !important;
  }
  /* æ–°ã—ã„ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  */
  .log-red {
    color: red;
  }
  .log-cyan {
    color: blue;
  }

  /* è»è‰¦å»ºé€ å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  #warshipBuildInputs {
      display: none;
      margin-top: 1em;
      border: 1px solid #ccc;
      padding: 10px;
      background-color: #f9f9f9;
  }
  #warshipBuildInputs label {
      display: inline-block;
      width: 100px;
      margin-bottom: 5px;
  }
  #warshipBuildInputs input[type="text"],
  #warshipBuildInputs input[type="number"] {
      width: 150px;
      margin-bottom: 5px;
  }
  .warship-name-cap-2 {
    color: green;
  }
  .warship-name-cap-3 {
    color: blue;
  }
  .warship-name-cap-4 {
    color: purple;
  }
  .warship-name-cap-5 {
    color: red;
  }
 .warship-sp {
    color: orange;
  }
  </style>
</head>
<body>
<div id="gameControls" style="margin-bottom: 1em;">
  <label for="islandNameInput">å³¶ã®åå‰:</label>
  <input type="text" id="islandNameInput" value="MyIsland">
  <button onclick="saveGame()">ã‚»ãƒ¼ãƒ–</button>
  <button onclick="loadGame()">ãƒ­ãƒ¼ãƒ‰</button>
  <textarea id="saveLoadData" rows="5" cols="60" placeholder="ã“ã“ã«ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ãƒ­ãƒ¼ãƒ‰ã™ã‚‹éš›ã¯ã“ã“ã«ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚" style="display: block; margin-top: 1em;"></textarea>
  <p style="font-size: 0.8em; color: gray;">
    â€»ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã¯ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚ä¸Šè¨˜ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¡¨ç¤ºã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«è²¼ã‚Šä»˜ã‘ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚<br>
    ãƒ­ãƒ¼ãƒ‰ã™ã‚‹éš›ã¯ã€ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šè¨˜ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è²¼ã‚Šä»˜ã‘ã¦ã‹ã‚‰ã€Œãƒ­ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
  </p>
</div>

<p>ç ²æ’ƒå¯èƒ½æ•°ä¸Šé™: <span id="gunCount">0</span>å› </br>è³‡é‡‘: <span id="money">1000</span>G | é£Ÿæ–™: <span id="food">500</span> | äººå£: <span id="population">0</span>äºº | ã‚¿ãƒ¼ãƒ³: <span id="turn">0</span> | å³¶ã®åå‰: <span id="currentIslandName"></span></p>

<div>
    <label for="otherIslandActionInput">ä»–å³¶ã®è¡Œå‹•:</label>
    <input type="text" id="otherIslandActionInput" style="width: 400px; margin-bottom: 5px;" placeholder="ã“ã“ã«ä»–å³¶ã‹ã‚‰ã®è¡Œå‹•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
</div>
<div>
    <label for="actionForOtherIslandOutput">ä»–å³¶ã¸ã®è¡Œå‹•:</label>
    <input type="text" id="actionForOtherIslandOutput" style="width: 400px; margin-bottom: 5px;" readonly>
</div>
<button onclick="nextTurn()">â–¶ ã‚¿ãƒ¼ãƒ³ã‚’é€²ã‚ã‚‹</button>
<br>
<select id="actionSelect" onchange="updateConfirmButton()">
  <option value="">è¨ˆç”»ä¸€è¦§</option>
  <option value="buildFarm" data-myisland="true">è¾²å ´å»ºè¨­ (100G)</option>
  <option value="buildFactory" data-myisland="true">å·¥å ´å»ºè¨­ (100G)</option>
  <option value="enhanceFacility" data-myisland="true">è¨­å‚™å¼·åŒ– (10000G)</option>
  <option value="buildPort" data-myisland="true">æ¸¯å»ºè¨­ (3000G)</option>
  <option value="buildGun" data-myisland="true">ç ²å°å»ºè¨­ (1200G)</option>
  <option value="buildDefenseFacility" data-myisland="true">é˜²è¡›æ–½è¨­å»ºè¨­ (5000G)</option>
  <option value="flatten" data-myisland="true">æ•´åœ° (20G)</option>
  <option value="landfill" data-myisland="true">åŸ‹ã‚ç«‹ã¦ (600G)</option>
  <option value="dig" data-myisland="true">æ˜å‰Š (300G)</option>
  <option value="cutForest" data-myisland="true">ä¼æ¡ (ç„¡æ–™)</option>
  <option value="plantForest" data-myisland="true">æ¤æ— (200G)</option>
  <option value="exportFood" data-myisland="true">é£Ÿæ–™è¼¸å‡º (é£Ÿæ–™20)</option>
  <option value="bombard" data-anyisland="true">ç ²æ’ƒ (120G)</option>
  <option value="spreadBombard" data-anyisland="true">æ‹¡æ•£å¼¾ç ²æ’ƒ (500G)</option>
  <option value="ppBombard" data-anyisland="true">PPå¼¾ç ²æ’ƒ (10000000G)</option>
  <option value="selfDestructMilitaryFacility" data-myisland="true">è»äº‹æ–½è¨­è‡ªçˆ† (ç„¡æ–™)</option>
  <option value="goToOtherIsland" data-myisland="true">ä»–ã®å³¶ã«è¡Œã</option>
  <option value="returnToMyIsland" data-anyisland="true">è‡ªå³¶ã«æˆ»ã‚‹</option>
  <option value="buildWarship" data-myisland="true">è»è‰¦å»ºé€ </option>
  <option value="refuelWarship" data-myisland="true">ç‡ƒæ–™è£œçµ¦</option>
  <option value="resupplyWarshipAmmo" data-myisland="true">å¼¾è–¬è£œçµ¦</option>
  <option value="repairWarship" data-myisland="true">è»è‰¦ä¿®ç†</option>
  <option value="enhanceWarship" data-myisland="true">è»è‰¦å¢—å¼·</option>
  <option value="decommissionWarship" data-myisland="true">è»è‰¦é™¤ç±</option>
  <option value="dispatchWarship" data-myisland="true">è»è‰¦æ´¾é£</option>
  <option value="requestWarshipReturn" data-myisland="true">è»è‰¦å¸°é‚„è¦è«‹</option>
  <option value="buildMonument" data-myisland="true">çŸ³ç¢‘å»ºè¨­ (500000000G)</option>
  <option value="upgradeMonument" data-myisland="true">çŸ³ç¢‘å¼·åŒ– (500000000G)</option>
  <option value="sellMonument" data-myisland="true">çŸ³ç¢‘å£²å´ (ç„¡æ–™)</option>
  <option value="initializeIsland" data-myisland="true">å³¶ã®åˆæœŸåŒ–</option>
</select>
<input type="number" id="exportAmount" placeholder="è¼¸å‡ºæ•°" min="1" style="width: 60px; display: none;">
<input type="number" id="bombardCount" placeholder="æ”»æ’ƒæ•°" min="1" style="width: 60px; display: none;">
<input type="number" id="refuelAmount" placeholder="è£œçµ¦æ•°" min="1" style="width: 60px; display: none;">
<input type="number" id="resupplyAmmoAmount" placeholder="è£œçµ¦æ•°" min="1" style="width: 60px; display: none;">
<input type="number" id="repairAmount" placeholder="å›å¾©è€ä¹…å€¤" min="1" style="width: 80px; display: none;">
<input type="text" id="touristCodeInput" placeholder="è¦³å…‰è€…ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" style="width: 250px; display: none;">
<div id="warshipBuildInputs">
    <h3>è»è‰¦å»ºé€ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h3>
    <div>
        <label for="warshipName">è‰¦å:</label>
        <input type="text" id="warshipName" maxlength="15" value="ç„¡éŠ˜è‰¦">
    </div>
    <div>
        <label for="warshipDurability">è€ä¹…åº¦:</label>
        <input type="number" id="warshipDurability" min="2" max="15" value="2"> (2ï½15, 1ã‚ãŸã‚Š10,000,000G)
    </div>
    <div>
        <label for="warshipMainGun">ä¸»ç ²:</label>
        <input type="number" id="warshipMainGun" min="1" max="5" value="1"> (1ï½5, 1ã‚ãŸã‚Š12,000,000G)
    </div>
    <div>
        <label for="warshipTorpedo">é­šé›·:</label>
        <input type="number" id="warshipTorpedo" min="0" max="3" value="0"> (0ï½3, 1ã‚ãŸã‚Š10,000,000G)
    </div>
    <div>
        <label for="warshipAntiAir">å¯¾ç©ºç ²:</label>
        <input type="number" id="warshipAntiAir" min="1" max="6" value="1"> (1ï½6, 1ã‚ãŸã‚Š5,000,000G)
    </div>
    <div>
        <label for="warshipAmmo">å¼¾è–¬åº«:</label>
        <input type="number" id="warshipAmmo" min="10" max="500" value="10"> (10ï½500, 1ã‚ãŸã‚Š100,000G)
    </div>
    <div>
        <label for="warshipRecon">åµå¯Ÿæ©Ÿ:</label>
        <input type="number" id="warshipRecon" min="0" max="2" value="0"> (0ï½2, 1ã‚ãŸã‚Š12,500,000G)
    </div>
    <div>
        <label for="warshipAccuracy">å°„æ’ƒç²¾åº¦å‘ä¸Š:</label>
        <input type="number" id="warshipAccuracy" min="0" max="2" value="0"> (0ï½2, 1ã‚ãŸã‚Š50,000,000G)
    </div>
</div>

<button onclick="confirmAction()" id="confirmBtn" disabled>æ±ºå®š</button>
<span id="tileInfo"></span>

<table id="map"></table>
<div id="log" style="margin-top:1em;"></div>

<script>
  let monster = null;
  const SIZE = 16;
  let money = 2500;
  let food = 1000;
  let population = 0;
  let turn = 0;
  let map = [];
  let selectedX = null, selectedY = null;
  let actionQueue = [];
  let islandName = "MyIsland";
  let warships = []; // è»è‰¦ã®é…åˆ—ã‚’è¿½åŠ 

  // è»è‰¦ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸Šé™å®šç¾©
  const WARSHIP_CAPS = {
      maxDurability: 30,
      mainGun: 15,
      antiAir: 35,
      maxFuel: 1000,
      maxAmmo: 1200
  };
  // ä¸Šé™åˆ°é”æ•°ã«å¿œã˜ã¦è»è‰¦åã®ã‚¯ãƒ©ã‚¹ã‚’è¿”ã™é–¢æ•°
  function getWarshipCapClass(ship) {
      let cappedCount = 0;
      if (ship.maxDurability >= WARSHIP_CAPS.maxDurability) cappedCount++;
      if (ship.mainGun >= WARSHIP_CAPS.mainGun) cappedCount++;
      if (ship.antiAir >= WARSHIP_CAPS.antiAir) cappedCount++;
      if (ship.maxFuel >= WARSHIP_CAPS.maxFuel) cappedCount++;
      if (ship.maxAmmo >= WARSHIP_CAPS.maxAmmo) cappedCount++;
      if (ship.exp === "NaN") cappedCount = 10;

      if (cappedCount === 2) return 'warship-name-cap-2';
      if (cappedCount === 3) return 'warship-name-cap-3';
      if (cappedCount === 4) return 'warship-name-cap-4';
      if (cappedCount === 5) return 'warship-name-cap-5';
      if (cappedCount === 10) return 'warship-sp';
      return ''; // ä¸Šé™åˆ°é”ãŒ2ã¤æœªæº€ã®å ´åˆã¯è‰²ã‚’ä»˜ã‘ãªã„
  }
let myIslandState = null; // è‡ªåˆ†ã®å³¶ã®çŠ¶æ…‹ã‚’ä¿å­˜ã™ã‚‹å¤‰æ•°
let isViewingOtherIsland = false; // ä»–ã®å³¶ã‚’è¦‹ã¦ã„ã‚‹ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°

function randTerrain() {
  const r = Math.random();
  // æµ·ãŒç”Ÿæˆã•ã‚Œã‚‹ç¢ºç‡ã‚‚åŠ ãˆã‚‹
  if (r < 0.2) return 'sea'; // æµ·ã®ç¢ºç‡ã‚’èª¿æ•´
  else if (r < 0.5) return 'plain';
  else if (r < 0.7) return 'waste';
  else return 'forest';
}
function getGunCount() {
    let targetMap = map;
    // ä»–ã®å³¶ã‚’è¦‹ã¦ã„ã‚‹å ´åˆã€è‡ªåˆ†ã®å³¶ã®çŠ¶æ…‹ã‹ã‚‰ç ²å°æ•°ã‚’å–å¾—ã™ã‚‹
    // ãŸã ã—ã€è‡ªå³¶çŠ¶æ…‹ãŒã¾ã ãªã„ï¼ˆåˆæœŸçŠ¶æ…‹ï¼‰å ´åˆã¯ç ²å°ã¯0ã¨ã™ã‚‹
    if (isViewingOtherIsland && myIslandState && myIslandState.map) {
        targetMap = myIslandState.map;
    } else if (isViewingOtherIsland && !myIslandState) {
        return 0;
    }

    if (targetMap.length === 0) return 0;

    // mapã‚’èµ°æŸ»ã—ã¦ç ²å° (facility: 'gun') ã®æ•°ã‚’æ•°ãˆã‚‹
    let count = 0;
    targetMap.forEach(row => {
        row.forEach(tile => {
            if (tile.facility === 'gun') {
                count++;
            }
        });
    });
    return count;
}
function initMap() {
  map = Array.from({ length: SIZE }, (_, y) =>
    Array.from({ length: SIZE }, (_, x) => {
      // å‘¨å›²4ãƒã‚¹ã‚’æµ·ã«ã™ã‚‹
      if (x < 4 || y < 4 || x >= SIZE - 4 || y >= SIZE - 4) {
        return { terrain: 'sea', facility: null, pop: 0, enhanced: false };
      }
      // ãƒ©ãƒ³ãƒ€ãƒ ãªé™¸åœ°é…ç½®ï¼ˆæ£®ã€å¹³åœ°ã€è’åœ°ï¼‰ã¨æµ·
      const terrain = randTerrain();
      return { terrain, facility: null, pop: 0, enhanced: false };
    })
  );
  let placed = 0;
  // åˆæœŸä½å®…ã‚’2ã¤é…ç½®
  // å¹³åœ°ã‚’æ¢ã—ã€ã™ã§ã«æ–½è¨­ãŒãªã„å ´æ‰€ã«é…ç½®ã™ã‚‹
  const possibleHouseLocations = [];
  for (let y = 4; y < SIZE - 4; y++) {
    for (let x = 4; x < SIZE - 4; x++) {
      const tile = map[y][x];
      if (tile.terrain === 'plain' && !tile.facility) {
        possibleHouseLocations.push({ x, y });
      }
    }
  }

  // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ ã«2ã¤é¸æŠ
  possibleHouseLocations.sort(() => Math.random() - 0.5);

  for (let i = 0; i < Math.min(2, possibleHouseLocations.length); i++) {
    const { x, y } = possibleHouseLocations[i];
    const tile = map[y][x];
    tile.facility = 'house';
    tile.pop = 25;
    population += 25;
    placed++;
  }
  document.getElementById('islandNameInput').value = islandName; // UIã«åˆæœŸå€¤ã‚’åæ˜ 
}

function updateStatus() {
  document.getElementById('money').textContent = money;
  document.getElementById('food').textContent = food < 0 ? 0 : food;
  document.getElementById('population').textContent = population < 0 ? 0 : population;
  document.getElementById('turn').textContent = turn;
  document.getElementById('currentIslandName').textContent = islandName;
  const guns = getGunCount();
  document.getElementById('gunCount').textContent = guns;
  // ä»–ã®å³¶ã‚’è¦‹ã¦ã„ã‚‹ã¨ãã¯è³‡é‡‘ã€é£Ÿæ–™ã€äººå£ã‚’éè¡¨ç¤ºã«ã™ã‚‹
  document.getElementById('money').style.visibility = isViewingOtherIsland ? 'hidden' : 'visible';
  document.getElementById('food').style.visibility = isViewingOtherIsland ? 'hidden' : 'visible';
  document.getElementById('population').style.visibility = isViewingOtherIsland ? 'hidden' : 'visible';
}

// confirmButtonã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
window.updateConfirmButton = function () {
  const action = document.getElementById('actionSelect').value;
  document.getElementById('confirmBtn').disabled = (action === "");
  document.getElementById('exportAmount').style.display = 'none';
  document.getElementById('bombardCount').style.display = 'none';
  document.getElementById('touristCodeInput').style.display = 'none';
  document.getElementById('warshipBuildInputs').style.display = 'none'; // è»è‰¦å»ºé€ å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤ºã«
  document.getElementById('refuelAmount').style.display = 'none'; // ç‡ƒæ–™è£œçµ¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤ºã«
  document.getElementById('resupplyAmmoAmount').style.display = 'none'; // å¼¾è–¬è£œçµ¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤ºã«
  document.getElementById('repairAmount').style.display = 'none'; // è»è‰¦ä¿®ç†ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤ºã«

  const actionSelect = document.getElementById('actionSelect');
  const options = actionSelect.options;

  for (let i = 0; i < options.length; i++) {
      const option = options[i];
      if (option.value === "") continue; // ã€Œè¨ˆç”»ä¸€è¦§ã€ã¯å¸¸ã«è¡¨ç¤º

      if (isViewingOtherIsland) {
          // ä»–ã®å³¶ã‚’è¦‹ã¦ã„ã‚‹å ´åˆ
          if (option.dataset.anyisland) { // data-anyislandå±æ€§ãŒã‚ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
              option.style.display = '';
          } else { // ãã‚Œä»¥å¤–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
              option.style.display = 'none';
          }
      } else {
          // è‡ªåˆ†ã®å³¶ã‚’è¦‹ã¦ã„ã‚‹å ´åˆ
          if (option.dataset.myisland || option.dataset.anyisland) { // data-myislandã¾ãŸã¯data-anyislandå±æ€§ãŒã‚ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
              option.style.display = '';
          } else {
              option.style.display = 'none';
          }
      }
  }

  if (action === 'exportFood') {
      document.getElementById('exportAmount').style.display = 'inline-block';
  } else if (action === 'bombard' || action === 'spreadBombard' || action === 'ppBombard') {
      document.getElementById('bombardCount').style.display = 'inline-block';
  } else if (action === 'goToOtherIsland' || action === 'dispatchWarship') { // è»è‰¦æ´¾é£ã§ã‚‚åŒã˜å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½¿ç”¨
      document.getElementById('touristCodeInput').style.display = 'inline-block';
  } else if (action === 'buildWarship') { // è»è‰¦å»ºé€ ãŒé¸æŠã•ã‚ŒãŸã‚‰ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
      document.getElementById('warshipBuildInputs').style.display = 'block';
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
      document.getElementById('warshipName').value = "ç„¡éŠ˜è‰¦";
      document.getElementById('warshipDurability').value = 2;
      document.getElementById('warshipMainGun').value = 1;
      document.getElementById('warshipTorpedo').value = 0;
      document.getElementById('warshipAntiAir').value = 1;
      document.getElementById('warshipAmmo').value = 10;
      document.getElementById('warshipRecon').value = 0;
      document.getElementById('warshipAccuracy').value = 0;
  } else if (action === 'refuelWarship') { // ç‡ƒæ–™è£œçµ¦ãŒé¸æŠã•ã‚ŒãŸã‚‰ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
      document.getElementById('refuelAmount').style.display = 'inline-block';
  } else if (action === 'resupplyWarshipAmmo') { // å¼¾è–¬è£œçµ¦ãŒé¸æŠã•ã‚ŒãŸã‚‰ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
      document.getElementById('resupplyAmmoAmount').style.display = 'inline-block';
  } else if (action === 'repairWarship') { // è»è‰¦ä¿®ç†ãŒé¸æŠã•ã‚ŒãŸã‚‰ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
      document.getElementById('repairAmount').style.display = 'inline-block';
  }
}


function renderMap() {
  const table = document.getElementById('map');
  table.innerHTML = '';
  for (let y = 0; y < SIZE; y++) {
    const row = document.createElement('tr');
    for (let x = 0; x < SIZE; x++) {
      const cell = document.createElement('td');
      const tile = map[y][x];

      // ä»–ã®å³¶ã‚’è¦‹ã¦ã„ã‚‹ã¨ãã¯ç ²å°ã¨é˜²è¡›æ–½è¨­ã‚’æ£®ã«å½è£…
      const displayFacility = (isViewingOtherIsland && (tile.facility === 'gun' || tile.facility === 'defenseFacility' || tile.facility === 'Monument')) ? 'forest' : tile.facility;
      const displayTerrain = (isViewingOtherIsland && (tile.facility === 'gun' || tile.facility === 'defenseFacility' || tile.facility === 'Monument')) ? 'forest' : tile.terrain;

      cell.className = displayTerrain; // åœ°å½¢ã‚¯ãƒ©ã‚¹
      if (displayFacility) cell.classList.add(displayFacility); // æ–½è¨­ã‚¯ãƒ©ã‚¹

      // å¼·åŒ–æ–½è¨­ã®ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      if (tile.enhanced) {
          if (tile.facility === 'farm') cell.classList.add('enhancedFarm');
          if (tile.facility === 'factory') cell.classList.add('enhancedFactory');
      }

      // è»è‰¦ã®è¡¨ç¤º
      const warshipAtTile = warships.find(ship => ship.x === x && ship.y === y);
      if (warshipAtTile && !isViewingOtherIsland) { // è‡ªåˆ†ã®å³¶ã‚’è¦‹ã¦ã„ã‚‹ã¨ãã®ã¿è»è‰¦ã‚’è¡¨ç¤º
          if (warshipAtTile.currentDurability <= 0) { // æ²ˆæ²¡ã—ã¦ã„ã‚‹å ´åˆ
              cell.classList.add('warship-wreckage');
              cell.textContent = 'x'; // æ®‹éª¸ã‚¢ã‚¤ã‚³ãƒ³
          } else {
              cell.classList.add('warship');
              if (warshipAtTile.isDispatched) {
                  cell.classList.add('warship-dispatched'); // æ´¾é£ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ«
                  cell.textContent = 'â›¶'; // æ´¾é£ä¸­ã‚¢ã‚¤ã‚³ãƒ³
              } else {
                  cell.textContent = 'ğŸš¢';
              }
          }
      } else {
          cell.textContent = displayFacility === 'farm' ? 'ğŸŒ¾' :
                             displayFacility === 'house' ? 'ğŸ ' :
                             displayFacility === 'factory' ? 'ğŸ­' :
                             displayFacility === 'gun' ? 'ğŸ”«' :
                             displayFacility === 'port' ? 'âš“' :
                             displayFacility === 'Monument' ? 'ğŸ—¿' :
                             displayFacility === 'defenseFacility' ? 'ğŸ›¡ï¸' : '';
      }


      // å¼·åŒ–æ–½è¨­ã®ã‚¢ã‚¤ã‚³ãƒ³ã¯ãã®ã¾ã¾
      if (tile.enhanced) {
          if (tile.facility === 'farm') cell.textContent = 'ğŸŒ¾';
          if (tile.facility === 'factory') cell.textContent = 'ğŸ­';
      }

      if (selectedX === x && selectedY === y) cell.classList.add('selected');
      cell.onmouseover = () => showTileInfo(x, y);
      cell.onclick = () => selectTile(x, y);
      row.appendChild(cell);
if (monster && monster.x === x && monster.y === y) {
  cell.textContent = 'ğŸ‘¾';
}
    }
    table.appendChild(row);
  }
}

function showTileInfo(x, y) {
  const tile = map[y][x];
  let info = ` (${x},${y}) åœ°å½¢: ${tile.terrain}`;
  if (tile.facility) {
    let facilityNameMap = {
        farm: 'è¾²å ´',
        house: 'ä½å®…',
        factory: 'å·¥å ´',
        gun: 'ç ²å°',
        port: 'æ¸¯',
        defenseFacility: 'é˜²è¡›æ–½è¨­',
        Monument: 'çŸ³ç¢‘'
    };


    let facilityName = facilityNameMap[tile.facility] || tile.facility;

    if (tile.enhanced) { // å¼·åŒ–æ–½è¨­ã®è¡¨ç¤ºå
        if (tile.facility === 'farm') facilityName = 'å¼·åŒ–è¾²å ´';
        if (tile.facility === 'factory') facilityName = 'å¼·åŒ–å·¥å ´';
    }
    info += ` / å»ºç‰©: ${facilityName}`;
    if (tile.facility === 'house' && !isViewingOtherIsland) info += ` (äººå£: ${tile.pop})`; // ä»–ã®å³¶ã§ã¯äººå£è¡¨ç¤ºãªã—
      if (tile.facility === 'Monument' && !isViewingOtherIsland) {
         info += ` (Lv: ${tile.MonumentLevel})`;
    }
  }

  const warshipAtTile = warships.find(ship => ship.x === x && ship.y === y);
  if (warshipAtTile && !isViewingOtherIsland) {
      // çµŒé¨“å€¤è¡¨ç¤ºã‚’ä¿®æ­£
      const expDisplay = warshipAtTile.exp === "NaN" ? "NaN" : warshipAtTile.exp;
      const warshipCapClass = getWarshipCapClass(warshipAtTile);
const warshipNameDisplay = warshipCapClass ? `<span class="${warshipCapClass}">${warshipAtTile.name}</span>` : warshipAtTile.name;
info += ` / è»è‰¦: ${warshipNameDisplay} (æ¯æ¸¯: ${warshipAtTile.homePort}, EXP: ${expDisplay}, è€ä¹…: ${warshipAtTile.currentDurability}/${warshipAtTile.maxDurability}, å¼¾è–¬: ${warshipAtTile.currentAmmo}/${warshipAtTile.maxAmmo}, ç‡ƒæ–™: ${warshipAtTile.currentFuel}/${warshipAtTile.maxFuel}`;
      if (warshipAtTile.isDispatched) {
          info += `, æ´¾é£ä¸­`;
      }
      if (warshipAtTile.currentDurability <= 0) {
          info += `, æ®‹éª¸`;
      }
      info += `)`;
  }
  document.getElementById('tileInfo').innerHTML = info;
}

function selectTile(x, y) {
  selectedX = x;
  selectedY = y;
  renderMap();
}

// logActioné–¢æ•°ã‚’ä¿®æ­£ã—ã¦ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«åŸºã¥ã„ã¦è‰²ã‚’é©ç”¨
function logAction(msg) {
  const log = document.getElementById('log');
  const entry = document.createElement('div');
  entry.textContent = `[ã‚¿ãƒ¼ãƒ³${turn}] ${msg}`;
  if (msg.includes('å¤±æ•—') || msg.includes('å°é¢¨') || msg.includes('éš•çŸ³') || msg.includes('ä¸è¶³') || msg.includes('å»ƒå¢Ÿ') || msg.includes('å£Šæ»…') || msg.includes('è¸ã¿è’ã‚‰ã—ã¾ã—ãŸ') || msg.includes('æ€ªç£ãŒå‡ºç¾') || msg.includes('è‡ªçˆ†') || msg.includes('æ”»æ’ƒã•ã‚Œã¾ã—ãŸ') || msg.includes('ç ²æ’ƒã‚’å—ã‘ã¾ã—ãŸ') || msg.includes('ç ´å£Šã•ã‚Œã¾ã—ãŸ') || msg.includes('æ’ƒæ²ˆã•ã‚Œã¾ã—ãŸ')) {
    entry.classList.add('log-red');
  } else if (msg.includes('å»ºè¨­') || msg.includes('å½¢æˆ') || msg.includes('è¨ä¼') || msg.includes('åˆæœŸåŒ–') || msg.includes('å¼·åŒ–') || msg.includes('è£œçµ¦') || msg.includes('ç§»å‹•ã—ã¾ã—ãŸ') || msg.includes('æ´¾é£') || msg.includes('å¸°é‚„') || msg.includes('è¦è«‹') || msg.includes('ä¿®ç†')) { // ä¿®ç†ã‚’è¿½åŠ 
    entry.classList.add('log-cyan');
  }
  log.prepend(entry);
}

// è¦³å…‰è€…ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
function generateTouristCode() {
    const simplifiedMap = map.map(row => row.map(tile => {
        let touristTerrain = tile.terrain;
        let touristFacility = tile.facility;

            if (touristFacility === 'gun' || touristFacility === 'defenseFacility' || touristFacility === 'Monument') {
            touristTerrain = 'forest';
            touristFacility = null;
        }
        return { terrain: touristTerrain, facility: touristFacility };
    }));
    const touristData = {
        map: simplifiedMap,
        islandName: islandName,
        turn: turn
    };
    const jsonString = JSON.stringify(touristData);
    // æ–°ã—ã„ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ–¹å¼ (btoaã¨encodeURIComponentã‚’çµ„ã¿åˆã‚ã›ã‚‹)
    return btoa(encodeURIComponent(jsonString));
}

// è»è‰¦ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›ã™ã‚‹é–¢æ•°
function encodeWarshipData(warship) {
    const data = {
        homePort: warship.homePort,
        name: warship.name,
        exp: warship.exp,
        currentFuel: warship.currentFuel,
        maxFuel: warship.maxFuel,
        maxDurability: warship.maxDurability,
        currentDurability: warship.currentDurability,
        mainGun: warship.mainGun,
        torpedo: warship.torpedo,
        antiAir: warship.antiAir,
        maxAmmo: warship.maxAmmo,
        currentAmmo: warship.currentAmmo,
        reconnaissance: warship.reconnaissance,
        accuracyImprovement: warship.accuracyImprovement,
        isDispatched: warship.isDispatched,
        originalCost: warship.originalCost || 0 // è¿½åŠ 
    };
    const jsonString = JSON.stringify(data);
    return btoa(encodeURIComponent(jsonString));
}

// ã‚³ãƒ¼ãƒ‰ã‹ã‚‰è»è‰¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°
function decodeWarshipData(encodedData) {
    const jsonString = decodeURIComponent(atob(encodedData));
    const data = JSON.parse(jsonString);
    // äº’æ›æ€§ç¶­æŒã®ãŸã‚ã®åˆæœŸåŒ–
    if (data.isDispatched === undefined) data.isDispatched = false;
    if (data.maxFuel === undefined) data.maxFuel = 100;
    if (data.originalCost === undefined) data.originalCost = 0; // è¿½åŠ 
    return data;
}


// è‡ªåˆ†ã®å³¶ã®çŠ¶æ…‹ã‚’ä¿å­˜
function saveGame() { // é–¢æ•°åã‚’saveGameã«å¤‰æ›´
    const gameState = {
        map: JSON.parse(JSON.stringify(map)), // ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼
        money: money,
        food: food,
        population: population,
        turn: turn,
        islandName: islandName,
        monster: monster ? JSON.parse(JSON.stringify(monster)) : null,
        actionQueue: JSON.parse(JSON.stringify(actionQueue)),
        warships: JSON.parse(JSON.stringify(warships)) // è»è‰¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    };
    const jsonString = JSON.stringify(gameState);
    // æ–°ã—ã„ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ–¹å¼ (btoaã¨encodeURIComponentã‚’çµ„ã¿åˆã‚ã›ã‚‹)
    document.getElementById('saveLoadData').value = btoa(encodeURIComponent(jsonString));
    logAction("ã‚²ãƒ¼ãƒ ãŒã‚»ãƒ¼ãƒ–ã•ã‚Œã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
}

// ã‚²ãƒ¼ãƒ ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°
function loadGame() { // é–¢æ•°åã‚’loadGameã«å¤‰æ›´
    const encodedData = document.getElementById('saveLoadData').value;
    if (!encodedData) {
        logAction("ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
    }
    try {
        // æ–°ã—ã„ãƒ‡ã‚³ãƒ¼ãƒ‰æ–¹å¼
        const jsonString = decodeURIComponent(atob(encodedData));
        const gameState = JSON.parse(jsonString);

        map = gameState.map;
        money = gameState.money;
        food = gameState.food;
        population = gameState.population;
        turn = gameState.turn;
        islandName = gameState.islandName || "MyIsland";
        monster = gameState.monster;
        actionQueue = gameState.actionQueue || []; // ãƒ­ãƒ¼ãƒ‰æ™‚ã«actionQueueãŒãªã„å ´åˆã«å¯¾å¿œ
        warships = gameState.warships || []; // è»è‰¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰

        // éå»ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã«enhancedãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆã®ãŸã‚ã«åˆæœŸåŒ–
        map.forEach(row => row.forEach(tile => {
            if (tile.enhanced === undefined) {
                tile.enhanced = false;
            }
            if (tile.MonumentLevel === undefined) {
                tile.MonumentLevel = 0;
            }
        }));
        // isDispatchedãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆã®åˆæœŸåŒ–
        warships.forEach(ship => {
            if (ship.isDispatched === undefined) {
                ship.isDispatched = false;
            }
            if (ship.maxFuel === undefined) { // æ—§ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ
                ship.maxFuel = 100;
            }
                if (ship.isKenzouWarship === undefined) {
                    ship.isKenzouWarship = false;
                }
            if (ship.originalCost === undefined) { // æ–°è¦ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ
                ship.originalCost = 0;
            }
        });

        document.getElementById('islandNameInput').value = islandName; // UIã«ãƒ­ãƒ¼ãƒ‰ã—ãŸåå‰ã‚’åæ˜ 
        isViewingOtherIsland = false; // ãƒ­ãƒ¼ãƒ‰æ™‚ã¯è‡ªåˆ†ã®å³¶ã«ã„ã‚‹
        saveMyIslandState(); // ãƒ­ãƒ¼ãƒ‰ã—ãŸçŠ¶æ…‹ã‚’è‡ªåˆ†ã®å³¶ã®çŠ¶æ…‹ã¨ã—ã¦ä¿å­˜
        logAction("ã‚²ãƒ¼ãƒ ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚");
        renderMap();
        updateStatus();
        document.getElementById('actionSelect').value = ""; // ã‚³ãƒãƒ³ãƒ‰é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
        updateConfirmButton(); // UIã‚’æ›´æ–°
    } catch (e) {
        logAction("ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã‚‹ã‹ã€å½¢å¼ãŒä¸æ­£ã§ã™ã€‚");
        console.error(e);
    }
}


// è‡ªåˆ†ã®å³¶ã®çŠ¶æ…‹ã‚’ä¿å­˜
function saveMyIslandState() {
    myIslandState = {
        map: JSON.parse(JSON.stringify(map)), // ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼
        money: money,
        food: food,
        population: population,
        turn: turn,
        islandName: islandName,
        monster: monster ? JSON.parse(JSON.stringify(monster)) : null,
        actionQueue: JSON.parse(JSON.stringify(actionQueue)),
        warships: JSON.parse(JSON.stringify(warships)) // è»è‰¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    };
    // localStorage ã«ã‚‚ä¿å­˜ã—ã¦ãŠãï¼ˆãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰å¯¾ç­–ï¼‰
    localStorage.setItem('myIslandState', JSON.stringify(myIslandState));
}

// è‡ªåˆ†ã®å³¶ã®çŠ¶æ…‹ã‚’ãƒ­ãƒ¼ãƒ‰
function loadMyIslandState() {
    const storedState = localStorage.getItem('myIslandState');
    if (storedState) {
        myIslandState = JSON.parse(storedState);
    } else {
        // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã‚„ä¿å­˜ã•ã‚Œã¦ã„ãªã„å ´åˆã¯åˆæœŸçŠ¶æ…‹
        myIslandState = {
            map: [], // initMapã§ç”Ÿæˆã•ã‚Œã‚‹
            money: 2500,
            food: 1000,
            population: 0,
            turn: 0,
            islandName: "MyIsland",
            monster: null,
            actionQueue: [],
            warships: [] // è»è‰¦ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
        };
        initMap(); // åˆæœŸãƒãƒƒãƒ—ç”Ÿæˆ
        saveMyIslandState(); // åˆæœŸçŠ¶æ…‹ã‚’ä¿å­˜
    }

    map = JSON.parse(JSON.stringify(myIslandState.map));
    money = myIslandState.money;
    food = myIslandState.food;
    population = myIslandState.population;
    turn = myIslandState.turn;
    islandName = myIslandState.islandName;
    monster = myIslandState.monster ? JSON.parse(JSON.stringify(myIslandState.monster)) : null;
    actionQueue = JSON.parse(JSON.stringify(myIslandState.actionQueue));
    warships = myIslandState.warships ? JSON.parse(JSON.stringify(myIslandState.warships)) : []; // è»è‰¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
    // isDispatchedãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆã®åˆæœŸåŒ–
    warships.forEach(ship => {
        if (ship.isDispatched === undefined) {
            ship.isDispatched = false;
        }
        if (ship.maxFuel === undefined) { // æ—§ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ
            ship.maxFuel = 100;
        }
        if (ship.originalCost === undefined) { // æ–°è¦ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ
            ship.originalCost = 0;
        }
    });

    // éå»ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã«enhancedãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆã®ãŸã‚ã«åˆæœŸåŒ–
    map.forEach(row => row.forEach(tile => {
        if (tile.enhanced === undefined) {
            tile.enhanced = false;
        }
        if (tile.MonumentLevel === undefined) {
            tile.MonumentLevel = 0;
        }
    }));


    isViewingOtherIsland = false;
    updateStatus();
    renderMap();
    logAction("è‡ªå³¶ã«æˆ»ã‚Šã¾ã—ãŸã€‚");
    document.getElementById('actionSelect').value = ""; // ã‚³ãƒãƒ³ãƒ‰é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
    updateConfirmButton(); // UIã‚’æ›´æ–°
}


// ã‚²ãƒ¼ãƒ ã‚’åˆæœŸè¨­å®šã«æˆ»ã™é–¢æ•°
function resetGame() {
    money = 2500;
    food = 1000;
    population = 0;
    turn = 0;
    islandName = "MyIsland";
    monster = null;
    actionQueue = [];
    warships = []; // è»è‰¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
    selectedX = null;
    selectedY = null;

    document.getElementById('islandNameInput').value = islandName;
    document.getElementById('otherIslandActionInput').value = '';
    document.getElementById('actionForOtherIslandOutput').value = '';
    document.getElementById('touristCodeInput').value = '';

    initMap(); // ãƒãƒƒãƒ—ã‚’å†åˆæœŸåŒ–
    saveMyIslandState(); // åˆæœŸåŒ–ã•ã‚ŒãŸçŠ¶æ…‹ã‚’ä¿å­˜
    updateStatus();
    renderMap();
    isViewingOtherIsland = false; // åˆæœŸåŒ–æ™‚ã¯è‡ªåˆ†ã®å³¶ã«ã„ã‚‹
    document.getElementById('actionSelect').value = "";
    updateConfirmButton();
    logAction("å³¶ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸã€‚");
}

// ç‰¹å®šã®åº§æ¨™ãŒé˜²è¡›æ–½è¨­ã«ã‚ˆã£ã¦å®ˆã‚‰ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
// ä¿®æ­£ï¼šå®ˆã‚‰ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®é˜²è¡›æ–½è¨­ã®ã‚¿ã‚¤ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™ã‚ˆã†ã«ã™ã‚‹
function getProtectingDefenseFacility(targetX, targetY) {
    for (let y = 0; y < SIZE; y++) {
        for (let x = 0; x < SIZE; x++) {
            const tile = map[y][x];
            if (tile.facility === 'defenseFacility') {
                const dist = Math.max(Math.abs(x - targetX), Math.abs(y - targetY));
                if (dist <= 2) { // é˜²è¡›æ–½è¨­ã®å‘¨å›²2ãƒã‚¹
                    return tile; // é˜²è¡›æ–½è¨­ã®ã‚¿ã‚¤ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™
                }
            }
        }
    }
    return null; // ä¿è­·ã•ã‚Œã¦ã„ãªã„å ´åˆã¯nullã‚’è¿”ã™
}

function handleWarshipAttacks() {
    // A copy of map and islandName to allow the function to work on the current *global* state.
    const currentMap = map;
    const currentIslandName = islandName;

    // Filter for active, dispatched warships not at their home island and with ammo
    const activeAttackingWarships = warships.filter(ship =>
        ship.currentDurability > 0 &&
        ship.currentAmmo > 0 &&
        ship.homePort !== currentIslandName // Only attack if not at home port
    );

    activeAttackingWarships.forEach(warship => {
        let attacksPerformed = 0;
        const totalAttacks = warship.mainGun + warship.torpedo;

        logAction(`${warship.name} (${warship.homePort}ç±) ãŒè‡ªå‹•æ”»æ’ƒã‚’é–‹å§‹ã—ã¾ã™ã€‚`);
        let attackRadius = 1; // 3x3 range (radius 1 from center means 1 tile in each direction, so 3x3 total)
        if (warship.reconnaissance === 1) attackRadius = 2; // 5x5 range
        if (warship.reconnaissance === 2) attackRadius = 3; // 7x7 range


        for (let i = 0; i < totalAttacks; i++) {
            if (warship.currentAmmo <= 0) {
                logAction(`${warship.name} ã¯å¼¾è–¬ãŒãªããªã‚Šã¾ã—ãŸã€‚`);
                break;
            }

            // Randomly select a target within the attack range
            let targetX, targetY;
            let validTargetFound = false;
            let attempts = 0;
            const maxAttempts = 100; // Prevent infinite loops

            while (!validTargetFound && attempts < maxAttempts) {
                targetX = warship.x + Math.floor(Math.random() * (2 * attackRadius + 1)) - attackRadius;
                targetY = warship.y + Math.floor(Math.random() * (2 * attackRadius + 1)) - attackRadius;

                // Check bounds and ensure it's not the warship's own location
                if (targetX >= 0 && targetX < SIZE && targetY >= 0 && targetY < SIZE &&
                    !(targetX === warship.x && targetY === warship.y)) {

                    const targetTile = currentMap[targetY][targetX];

                    // Exclude waste and sea unless it has a facility/monster/other warship
                    const isSeaOrWasteWithoutFacility =
                        (targetTile.terrain === 'sea' || targetTile.terrain === 'waste') &&
                        !targetTile.facility &&
                        !(monster && monster.x === targetX && monster.y === targetY) &&
                        !(warships.find(ship => ship.x === targetX && ship.y === targetY && ship !== warship)); // Check for other warships

                    const targetWarship = warships.find(ship => ship.x === targetX && ship.y === targetY && ship !== warship);
                    const isTargetSameHomeportWarship = targetWarship && (targetWarship.homePort === warship.homePort);
                    const isWreckage = targetWarship && targetWarship.currentDurability <= 0;

                    if (!isSeaOrWasteWithoutFacility && !isTargetSameHomeportWarship && !isWreckage) {
                        validTargetFound = true;
                    }
                }
                attempts++;
            }

            if (!validTargetFound) {
                logAction(`${warship.name} ã¯æ”»æ’ƒå¯èƒ½ãªç›®æ¨™ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚`);
                continue; // Skip this attack
            }

            const targetTile = currentMap[targetY][targetX];
            let hitChance = 0.10; // Base 10%
            if (warship.accuracyImprovement === 1) {
                hitChance = 0.15;
            } else if (warship.accuracyImprovement === 2) {
                hitChance = 0.22;
            }

            // Defense facility interference (only if accuracyImprovement is not 1)
            let protectingDefenseFacility = null;
            if (warship.accuracyImprovement !== 1) {
                protectingDefenseFacility = getProtectingDefenseFacility(targetX, targetY);
                if (protectingDefenseFacility) {
                    hitChance *= 0.5; // Halve hit chance if protected by a defense facility
                    logAction(`é˜²è¡›æ–½è¨­ã®å¹²æ¸‰ã«ã‚ˆã‚Šã€${warship.name} ã®æ”»æ’ƒç²¾åº¦ãŒä½ä¸‹ã—ã¾ã—ãŸã€‚`);
                }
            }


            if (Math.random() < hitChance) {
                logAction(`${warship.name} ã®æ”»æ’ƒãŒ (${targetX},${targetY}) ã«å‘½ä¸­ï¼`);
                warship.currentAmmo--;
                attacksPerformed++;

                let expGained = 0;
                let targetType = "ä¸æ˜ãªæ–½è¨­";

                // Check for monster hit
                if (monster && monster.x === targetX && monster.y === targetY) {
                    expGained += 1;
                    targetType = "æ€ªç£";
                    monster = null; // Monster is "destroyed"
                    logAction(`${warship.name} ã¯æ€ªç£ã‚’è¨ä¼ã—ã€1 EXPã‚’ç²å¾—ã—ã¾ã—ãŸï¼`);
                } else {
                    // Check for other warship hit (assume any other warship on the map is an "enemy" if it's not from our homeport)
                    const otherWarshipAtTarget = warships.find(ship => ship.x === targetX && ship.y === targetY && ship !== warship && ship.homePort !== warship.homePort); // Ensure it's not our own warship or from same homeport
                    if (otherWarshipAtTarget) {
                        expGained += 1;
                        targetType = "æ•µè»è‰¦";
                        otherWarshipAtTarget.currentDurability -= 1; // Reduce durability
                        logAction(`${warship.name} ã¯æ•µè»è‰¦ã€Œ${otherWarshipAtTarget.name}ã€ã‚’æ”»æ’ƒã—ã€1 EXPã‚’ç²å¾—ã—ã¾ã—ãŸï¼ æ®‹ã‚Šè€ä¹…: ${otherWarshipAtTarget.currentDurability}`);
                        if (otherWarshipAtTarget.currentDurability <= 0) {
                            targetWarship.currentDurability = 0; // 0ä»¥ä¸‹ã«ãªã‚‰ãªã„ã‚ˆã†ã«
                            targetWarship.fuel = 0; // æ®‹ã‚Šç‡ƒæ–™ã‚’0ã«
                            targetWarship.currentFuel = 0; // ç¾åœ¨ç‡ƒæ–™ã‚‚0ã«
                            targetWarship.ammo = 0; // æ®‹ã‚Šå¼¾è–¬ã‚’0ã«
                            targetWarship.currentAmmo = 0; // ç¾åœ¨å¼¾è–¬ã‚‚0ã«
                            logAction(`æ•µè»è‰¦ã€Œ${otherWarshipAtTarget.name}ã€ã‚’æ’ƒæ²ˆã—ã¾ã—ãŸï¼`);
                            // For simplicity, a destroyed warship remains as wreckage on the map. renderMap will show 'x'.
                        }
                    } else if (targetTile.facility === 'house') { // House hit
    expGained += Math.floor(targetTile.pop / 2500);
    targetType = "ä½å®…";
    logAction(`${warship.name} ã¯ä½å®… (${targetTile.pop}äºº) ã‚’æ”»æ’ƒã—ã€${expGained} EXPã‚’ç²å¾—ã—ã¾ã—ãŸï¼`);
    population -= targetTile.pop;
    if (population < 0) population = 0;
    targetTile.pop = 0; // Destroy population
    targetTile.facility = null; // Remove facility
    targetTile.terrain = 'waste'; // Turn into waste
    targetTile.enhanced = false; // Remove enhancement
    } else if(targetTile.Monument) {
                targetType = 'çŸ³ç¢‘';
                if (targetTile.MonumentLevel >= 2) {
                    targetTile.MonumentLevel -= 1; // ãƒ¬ãƒ™ãƒ«ã‚’1ä¸‹ã’ã‚‹
                    logAction(`${warship.name} ã®æ”»æ’ƒã«ã‚ˆã‚Šã€çŸ³ç¢‘ã®ãƒ¬ãƒ™ãƒ«ãŒ1ä½ä¸‹ã—ã¾ã—ãŸ (Lv${targetTile.MonumentLevel})ã€‚`);
                } else { // ãƒ¬ãƒ™ãƒ«1ã®å ´åˆ
                    logAction(`${warship.name} ã¯çŸ³ç¢‘ï¼ˆLv1ï¼‰ã‚’ç ´å£Šã—ã¾ã—ãŸã€‚`);
                    targetTile.facility = null;
                    targetTile.terrain = 'waste'; // è’ã‚Œåœ°ã«ãªã‚‹
                    targetTile.MonumentLevel = 0; // ãƒ¬ãƒ™ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                }
    } else if(targetTile.facility) {
                        // Hit another facility (gun, factory, farm, port, defenseFacility)
                        targetType = targetTile.facility;
                        logAction(`${warship.name} ã¯ ${targetType} ã‚’ç ´å£Šã—ã¾ã—ãŸã€‚`);
                        targetTile.facility = null;
                        targetTile.terrain = 'waste'; // Turn into waste
                        targetTile.enhanced = false; // Remove enhancement
                    }else {
                        // Hit a terrain without facility (plain, forest)
                        targetType = targetTile.terrain;
                        logAction(`${warship.name} ã¯ ${targetType} ã‚’è’åœ°ã«ã—ã¾ã—ãŸã€‚`);
                        targetTile.terrain = 'waste';
                    }
                }
if (warship.exp === "NaN") {
    return;
}
                warship.exp += expGained;
            } else {
                logAction(`${warship.name} ã®æ”»æ’ƒã¯å¤–ã‚Œã¾ã—ãŸã€‚`);
                warship.currentAmmo--; // Still consume ammo on miss
                attacksPerformed++;
            }
        }
        if (attacksPerformed > 0) {
            logAction(`${warship.name} ã¯åˆè¨ˆ ${attacksPerformed} å›ã®æ”»æ’ƒã‚’è¡Œã„ã¾ã—ãŸã€‚`);
        }
    });
}

// confirmActioné–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§å®šç¾©
window.confirmAction = function () {
  const action = document.getElementById('actionSelect').value;
  const targetTileSelected = (selectedX !== null && selectedY !== null);

  // ä»–ã®å³¶ã‚’è¦‹ã¦ã„ã‚‹ã¨ãã®å‡¦ç†
  if (isViewingOtherIsland) {
      if (action === 'bombard' || action === 'spreadBombard' || action === 'ppBombard') {
          if (!targetTileSelected) {
              logAction(`ç ²æ’ƒå¯¾è±¡ã®ã‚¿ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„`);
              return;
          }
          const count = parseInt(document.getElementById('bombardCount').value);
          if (isNaN(count) || count <= 0) {
              logAction(`ç ²æ’ƒã®æ•°ãŒæ­£ã—ãæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“`);
              return;
          }
          const guns = getGunCount(); // è‡ªå³¶ã®ç ²å°æ•°ã‚’å–å¾—
              if (guns === 0) {
                logAction(`ç ²æ’ƒã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç ²å°ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰`);
                return;
              }
              if (count > guns) {
                logAction(`ç ²æ’ƒã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç ²æ’ƒæ•°ãŒä¿æœ‰ç ²å°æ•° (${guns}) ã‚’è¶…ãˆã¦ã„ã¾ã™ï¼‰`);
                return;
              }
          // è¡Œå‹•å†…å®¹ã‚’åœ§ç¸®ãƒ»æš—å·åŒ–ã—ã¦ä»–å³¶ã¸ã®è¡Œå‹•ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«å‡ºåŠ›
          const actionData = {
              type: action,
              x: selectedX,
              y: selectedY,
              count: count
          };
          // æ–°ã—ã„ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ–¹å¼ (btoaã¨encodeURIComponentã‚’çµ„ã¿åˆã‚ã›ã‚‹)
          const encodedAction = btoa(encodeURIComponent(JSON.stringify(actionData)));
          document.getElementById('actionForOtherIslandOutput').value = encodedAction;
          logAction(`ä»–å³¶ã¸ã®è¡Œå‹•ãŒã€Œä»–å³¶ã¸ã®è¡Œå‹•ã€æ¬„ã«å‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚`);
          document.getElementById('actionSelect').value = ""; // ã‚³ãƒãƒ³ãƒ‰é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
          updateConfirmButton(); // UIã‚’æ›´æ–°
          return;
      } else if (action === 'returnToMyIsland') {
          loadMyIslandState(); // è‡ªåˆ†ã®å³¶ã«æˆ»ã‚‹
          document.getElementById('actionForOtherIslandOutput').value = generateTouristCode(); // è‡ªåˆ†ã®è¦³å…‰è€…ã‚³ãƒ¼ãƒ‰ã‚’å‡ºåŠ›
          return;
      } else {
          logAction(`ä»–ã®å³¶ã§ã¯ç ²æ’ƒç³»ã‚³ãƒãƒ³ãƒ‰ã‹ã€Œè‡ªå³¶ã«æˆ»ã‚‹ã€ã®ã¿å®Ÿè¡Œå¯èƒ½ã§ã™ã€‚`);
          document.getElementById('actionSelect').value = ""; // ã‚³ãƒãƒ³ãƒ‰é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
          updateConfirmButton(); // UIã‚’æ›´æ–°
          return;
      }
  }


  // è‡ªåˆ†ã®å³¶ã‚’è¦‹ã¦ã„ã‚‹ã¨ãã®å‡¦ç†
  // 1ã‚¿ãƒ¼ãƒ³ã«2ã¤ã¾ã§ã—ã‹è¨ˆç”»ã§ããªã„ã‚ˆã†ã«ã™ã‚‹
  if (actionQueue.length >= 2) {
    logAction(`1ã‚¿ãƒ¼ãƒ³ã«è¨ˆç”»ã§ãã‚‹ã®ã¯2ã¤ã¾ã§ã§ã™ã€‚`);
    return;
  }

  if (!action) return;

  // ã‚¿ã‚¤ãƒ«é¸æŠãŒå¿…è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚¿ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆ
  const requiresTileSelection = ['buildFarm', 'buildFactory', 'buildPort', 'buildGun', 'buildDefenseFacility', 'buildWarship', 'refuelWarship', 'resupplyWarshipAmmo', 'repairWarship', 'dispatchWarship', 'requestWarshipReturn', 'flatten', 'landfill', 'dig', 'cutForest', 'plantForest', 'enhanceFacility', 'selfDestructMilitaryFacility', 'bombard', 'spreadBombard', 'ppBombard'];
  if (requiresTileSelection.includes(action) && !targetTileSelected) {
    logAction(`ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å¯¾è±¡ã‚¿ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„`);
    return;
  }

  let tile = null;
  if (targetTileSelected) {
      tile = map[selectedY][selectedX];
  }


  if (action === 'exportFood') {
    const amount = parseInt(document.getElementById('exportAmount').value);
    if (!isNaN(amount) && amount > 0) {
      actionQueue.push({ action, amount, x: null, y: null });
      logAction(`é£Ÿæ–™ã‚’ ${amount * 20} è¼¸å‡ºã™ã‚‹è¨ˆç”»ã‚’ç«‹ã¦ã¾ã—ãŸ`);
    } else {
      logAction(`é£Ÿæ–™è¼¸å‡ºã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè¼¸å‡ºæ•°ãŒæœªæŒ‡å®šã¾ãŸã¯ç„¡åŠ¹ï¼‰`);
    }
  } else if (action === 'bombard' || action === 'spreadBombard' || action === 'ppBombard') {
    const count = parseInt(document.getElementById('bombardCount').value);
    if (isNaN(count) || count <= 0) {
      logAction(`ç ²æ’ƒã®æ•°ãŒæ­£ã—ãæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“`);
      return;
    }
    const guns = getGunCount();
    if (guns === 0) {
      logAction(`ç ²æ’ƒã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç ²å°ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰`);
      return;
    }
    let cost = 0;
    if (action === 'bombard') cost = count * 120;
    else if (action === 'spreadBombard') cost = count * 500;
    else if (action === 'ppBombard') cost = count * 10000000; // PPå¼¾ã®ä¾¡æ ¼ã‚’æ›´æ–°

    if (money < cost) {
      logAction(`ç ²æ’ƒã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè³‡é‡‘ä¸è¶³ï¼‰`);
      return;
    }
    if (count > guns) { // ä¿æœ‰ã—ã¦ã„ã‚‹ç ²å°ã®æ•°ã¾ã§ã—ã‹ç ²æ’ƒã§ããªã„
      logAction(`ç ²æ’ƒã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆä¿æœ‰ç ²å°æ•°ã‚’è¶…ãˆã¦ã„ã¾ã™ï¼‰`);
      return;
    }
    actionQueue.push({ x: selectedX, y: selectedY, action, count });
    logAction(`(${selectedX},${selectedY}) ã« ${count}ç™ºã®${action === 'bombard' ? 'ç ²æ’ƒ' : action === 'spreadBombard' ? 'æ‹¡æ•£å¼¾ç ²æ’ƒ' : 'PPå¼¾ç ²æ’ƒ'}ã‚’è¨ˆç”»ã—ã¾ã—ãŸ`);
  } else if (action === 'selfDestructMilitaryFacility') { // åç§°å¤‰æ›´
    if (tile && (tile.facility === 'gun' || tile.facility === 'defenseFacility')) { // ãƒãƒªãƒœãƒ†æ–½è¨­ã‚’å‰Šé™¤
      actionQueue.push({ x: selectedX, y: selectedY, action });
      logAction(`(${selectedX},${selectedY}) ã®è»äº‹æ–½è¨­è‡ªçˆ†ã‚’è¨ˆç”»ã—ã¾ã—ãŸ`);
    } else {
      logAction(`(${selectedX},${selectedY}) ã«è»äº‹æ–½è¨­ãŒã‚ã‚Šã¾ã›ã‚“`);
    }
  } else if (action === 'goToOtherIsland') {
      const touristCode = document.getElementById('touristCodeInput').value;
      if (touristCode) {
          try {
              const jsonString = decodeURIComponent(atob(touristCode));
              const otherIslandData = JSON.parse(jsonString);

              saveMyIslandState(); // è‡ªåˆ†ã®å³¶ã®çŠ¶æ…‹ã‚’ä¿å­˜
              map = otherIslandData.map;
              islandName = otherIslandData.islandName;
              turn = otherIslandData.turn; // ä»–ã®å³¶ã®ã‚¿ãƒ¼ãƒ³æ•°ã«ä¸€æ™‚çš„ã«åˆã‚ã›ã‚‹
              money = 0; food = 0; population = 0; // ä»–ã®å³¶ã®æƒ…å ±ã¯é™å®šè¡¨ç¤º
              monster = null;
              isViewingOtherIsland = true;
              logAction(`ã€Œ${islandName}ã€ã«ç§»å‹•ã—ã¾ã—ãŸã€‚`);
              renderMap();
              updateStatus();
              document.getElementById('actionSelect').value = ""; // ã‚³ãƒãƒ³ãƒ‰é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
              updateConfirmButton(); // UIã‚’æ›´æ–°
          } catch (e) {
              logAction(`è¦³å…‰è€…ã‚³ãƒ¼ãƒ‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
              console.error(e);
          }
      } else {
          logAction(`è¦³å…‰è€…ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
      }
  } else if (action === 'returnToMyIsland') {
      loadMyIslandState(); // è‡ªåˆ†ã®å³¶ã«æˆ»ã‚‹
      document.getElementById('actionForOtherIslandOutput').value = generateTouristCode(); // è‡ªåˆ†ã®è¦³å…‰è€…ã‚³ãƒ¼ãƒ‰ã‚’å‡ºåŠ›
  } else if (action === 'initializeIsland') { // æ–°ã—ã„ã‚³ãƒãƒ³ãƒ‰ã®å‡¦ç†
if (confirm('æœ¬å½“ã«ã“ã®æ“ä½œã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ')) {
      resetGame();
} else {
logAction(`å³¶ã®åˆæœŸåŒ–ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚`);
}
  } else if (action === 'buildDefenseFacility') { // é˜²è¡›æ–½è¨­å»ºè¨­
      if (tile && tile.terrain === 'plain' && money >= 5000) {
        actionQueue.push({ x: selectedX, y: selectedY, action });
        logAction(`(${selectedX},${selectedY}) ã«é˜²è¡›æ–½è¨­å»ºè¨­ã‚’è¨ˆç”»ã—ã¾ã—ãŸ`);
      } else logAction(`(${selectedX},${selectedY}) ã®é˜²è¡›æ–½è¨­å»ºè¨­ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
  }
  else if (action === 'enhanceFacility') { // è¨­å‚™å¼·åŒ–
      if (tile && (tile.facility === 'farm' || tile.facility === 'factory') && !tile.enhanced && money >= 10000) {
          actionQueue.push({ x: selectedX, y: selectedY, action });
          logAction(`(${selectedX},${selectedY}) ã®è¨­å‚™å¼·åŒ–ã‚’è¨ˆç”»ã—ã¾ã—ãŸ`);
      } else {
          logAction(`(${selectedX},${selectedY}) ã®è¨­å‚™å¼·åŒ–ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆå¯¾è±¡æ–½è¨­ãŒãªã„ã‹ã€æ—¢ã«å¼·åŒ–æ¸ˆã¿ã‹ã€è³‡é‡‘ä¸è¶³ï¼‰`);
      }
  } else if (action === 'buildWarship') { // è»è‰¦å»ºé€ 
      if (!targetTileSelected) {
          logAction("è»è‰¦ã‚’å»ºé€ ã™ã‚‹æµ·åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
          return;
      }
      // æ¸¯ã«éš£æ¥ã™ã‚‹æµ·åŸŸã‹ãƒã‚§ãƒƒã‚¯
      let adjacentToPort = false;
      for (let dx = -1; dx <= 1; dx++) {
          for (let dy = -1; dy <= 1; dy++) {
              const nx = selectedX + dx;
              const ny = selectedY + dy;
              if (nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE && (dx !== 0 || dy !== 0)) {
                  if (map[ny][nx].facility === 'port') {
                      adjacentToPort = true;
                      break;
                  }
              }
          }
          if (adjacentToPort) break;
      }
      if (!adjacentToPort) {
          logAction("è»è‰¦ã¯æ¸¯ã«éš£æ¥ã™ã‚‹æµ·åŸŸã«ã®ã¿å»ºé€ å¯èƒ½ã§ã™ã€‚");
          return;
      }
      if (tile.terrain !== 'sea' || tile.facility !== null) {
          logAction(`(${selectedX},${selectedY}) ã¯è»è‰¦ã‚’å»ºé€ ã§ãã‚‹æµ·åŸŸã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
          return;
      }
      // Check if a warship already exists at the selected tile
      const existingWarship = warships.find(ship => ship.x === selectedX && ship.y === selectedY);
      if (existingWarship) {
          logAction(`(${selectedX},${selectedY}) ã«ã¯æ—¢ã«è»è‰¦ã€Œ${existingWarship.name}ã€ãŒå­˜åœ¨ã—ã¾ã™ã€‚`);
          return;
      }
      const name = document.getElementById('warshipName').value.trim();
      const durability = parseInt(document.getElementById('warshipDurability').value);
      const mainGun = parseInt(document.getElementById('warshipMainGun').value);
      const torpedo = parseInt(document.getElementById('warshipTorpedo').value);
      const antiAir = parseInt(document.getElementById('warshipAntiAir').value);
      const ammo = parseInt(document.getElementById('warshipAmmo').value);
      const recon = parseInt(document.getElementById('warshipRecon').value);
      const accuracy = parseInt(document.getElementById('warshipAccuracy').value);

      if (!name || name.length > 15) {
          logAction("è‰¦åã¯1æ–‡å­—ä»¥ä¸Š15æ–‡å­—ä»¥ä¸‹ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          return;
      }
      if (isNaN(durability) || durability < 2 || durability > 15) {
          logAction("è€ä¹…åº¦ã¯2ï½15ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
          return;
      }
      if (isNaN(mainGun) || mainGun < 1 || mainGun > 5) {
          logAction("ä¸»ç ²ã¯1ï½5ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
          return;
      }
      if (isNaN(torpedo) || torpedo < 0 || torpedo > 3) {
          logAction("é­šé›·ã¯0ï½3ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
          return;
      }
      if (isNaN(antiAir) || antiAir < 1 || antiAir > 6) {
          logAction("å¯¾ç©ºç ²ã¯1ï½6ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
          return;
      }
      if (isNaN(ammo) || ammo < 10 || ammo > 500) {
          logAction("å¼¾è–¬åº«ã¯10ï½500ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
          return;
      }
      if (isNaN(recon) || recon < 0 || recon > 2) {
          logAction("åµå¯Ÿæ©Ÿã¯0ï½2ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
          return;
      }
      if (isNaN(accuracy) || accuracy < 0 || accuracy > 2) {
          logAction("å°„æ’ƒç²¾åº¦å‘ä¸Šã¯0ï½2ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
          return;
      }

        const cost = (durability * 10000000) + (mainGun * 12000000) + (torpedo * 10000000) + (antiAir * 5000000) + (ammo * 100000) + (recon * 12500000) + (accuracy * 50000000);
        if (money < cost) {
            const needed = cost - money; // ä¸è¶³é‡‘é¡ã‚’è¨ˆç®—
            logAction(`è»è‰¦å»ºé€ ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè³‡é‡‘ä¸è¶³: ${needed}G ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼‰`); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿®æ­£
            return;
        }
      actionQueue.push({ x: selectedX, y: selectedY, action, warshipData: { name, durability, mainGun, torpedo, antiAir, ammo, recon, accuracy, originalCost: cost } }); // originalCostã‚’è¿½åŠ 
      logAction(`(${selectedX},${selectedY}) ã«è»è‰¦ã€Œ${name}ã€ã®å»ºé€ ã‚’è¨ˆç”»ã—ã¾ã—ãŸ (è²»ç”¨: ${cost}G)`);
  } else if (action === 'refuelWarship') { // ç‡ƒæ–™è£œçµ¦
      const warship = warships.find(ship => ship.x === selectedX && ship.y === selectedY);
      if (!warship) {
          logAction(`(${selectedX},${selectedY}) ã«è»è‰¦ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚`);
          return;
      }
      if (warship.isDispatched) {
          logAction(`æ´¾é£ä¸­ã®è»è‰¦ã«ã¯ç‡ƒæ–™è£œçµ¦ã§ãã¾ã›ã‚“ã€‚`);
          return;
      }
      const amount = parseInt(document.getElementById('refuelAmount').value);
      if (isNaN(amount) || amount <= 0) {
          logAction(`è£œçµ¦æ•°ãŒæ­£ã—ãæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`);
          return;
      }
      const cost = amount * 500; // é£Ÿæ–™500
      if (food < cost) {
          logAction(`ç‡ƒæ–™è£œçµ¦ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé£Ÿæ–™ä¸è¶³: ${cost} å¿…è¦ï¼‰`);
          return;
      }
      actionQueue.push({ x: selectedX, y: selectedY, action, amount });
      logAction(`(${selectedX},${selectedY}) ã®è»è‰¦ã«ç‡ƒæ–™ ${amount} ã‚’è£œçµ¦ã™ã‚‹è¨ˆç”»ã‚’ç«‹ã¦ã¾ã—ãŸ (é£Ÿæ–™ ${cost} æ¶ˆè²»)`);
  } else if (action === 'resupplyWarshipAmmo') { // å¼¾è–¬è£œçµ¦
      const warship = warships.find(ship => ship.x === selectedX && ship.y === selectedY);
      if (!warship) {
          logAction(`(${selectedX},${selectedY}) ã«è»è‰¦ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚`);
          return;
      }
      if (warship.isDispatched) {
          logAction(`æ´¾é£ä¸­ã®è»è‰¦ã«ã¯å¼¾è–¬è£œçµ¦ã§ãã¾ã›ã‚“ã€‚`);
          return;
      }
      const amount = parseInt(document.getElementById('resupplyAmmoAmount').value);
      if (isNaN(amount) || amount <= 0) {
          logAction(`è£œçµ¦æ•°ãŒæ­£ã—ãæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`);
          return;
      }
      const cost = amount * 20000; // 20000G
      if (money < cost) {
          logAction(`å¼¾è–¬è£œçµ¦ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè³‡é‡‘ä¸è¶³: ${cost}G å¿…è¦ï¼‰`);
          return;
      }
      actionQueue.push({ x: selectedX, y: selectedY, action, amount });
      logAction(`(${selectedX},${selectedY}) ã®è»è‰¦ã«å¼¾è–¬ã‚’ ${amount} è£œçµ¦ã™ã‚‹è¨ˆç”»ã‚’ç«‹ã¦ã¾ã—ãŸ (è³‡é‡‘ ${cost}G æ¶ˆè²»)`);
  }else if (action === 'repairWarship') {
    if (!targetTileSelected) {
        logAction(`ä¿®ç†å¯¾è±¡ã®è»è‰¦ãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`);
        return;
    }
    const ship = warships.find(s => s.x === selectedX && s.y === selectedY);
    if (!ship) {
        logAction(`é¸æŠã—ãŸã‚¿ã‚¤ãƒ«ã«è»è‰¦ãŒã„ã¾ã›ã‚“ã€‚`);
        return;
    }
    // æ’ƒæ²ˆã•ã‚Œã¦ã„ã‚‹è»è‰¦ã¯ä¿®ç†ã§ããªã„ã‚ˆã†ã«ã™ã‚‹
    if (ship.currentDurability <= 0) {
        logAction(`${ship.name} ã¯æ’ƒæ²ˆã•ã‚Œã¦ãŠã‚Šã€ä¿®ç†ã§ãã¾ã›ã‚“ã€‚`);
        return;
    }
    if (ship.isDispatched) {
        logAction(`${ship.name} ã¯æ´¾é£ä¸­ãªã®ã§ä¿®ç†ã§ãã¾ã›ã‚“ã€‚`);
        return;
    }
    const repairAmount = parseInt(document.getElementById('repairAmount').value);
    if (isNaN(repairAmount) || repairAmount <= 0) {
        logAction(`å›å¾©è€ä¹…å€¤ãŒæ­£ã—ãæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`);
        return;
    }

    const costPerDurability = 500000; // è€ä¹…åº¦1å›å¾©ã‚ãŸã‚Šã®è²»ç”¨

    // å›å¾©å¯èƒ½ãªè€ä¹…å€¤ã‚’è¨ˆç®—
    const missingDurability = ship.maxDurability - ship.currentDurability;

    if (missingDurability <= 0) {
        logAction(`${ship.name} ã®è€ä¹…åº¦ã¯ã™ã§ã«æœ€å¤§ã§ã™ã€‚`);
        return;
    }
    const actualRepairAmount = Math.min(repairAmount, missingDurability);
    const actualCost = actualRepairAmount * costPerDurability;
    if (money < actualCost) {
        logAction(`è³‡é‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ä¿®ç†ã«ã¯ ${actualCost}G å¿…è¦ã§ã™ã€‚`);
        return;
    }

    money -= actualCost;
    ship.currentDurability += actualRepairAmount;
    logAction(`${ship.name} ã‚’ ${actualRepairAmount} è€ä¹…å€¤åˆ†ä¿®ç†ã—ã¾ã—ãŸã€‚è²»ç”¨: ${actualCost}Gã€‚ç¾åœ¨ã®è€ä¹…åº¦: ${ship.currentDurability}/${ship.maxDurability}`);
    renderMap();
    updateStatus();
    saveMyIslandState();
}else if (action === 'dispatchWarship') { // è»è‰¦æ´¾é£
      const warship = warships.find(ship => ship.x === selectedX && ship.y === selectedY);
      if (!warship) {
          logAction(`(${selectedX},${selectedY}) ã«è»è‰¦ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚`);
          return;
      }
      if (warship.isDispatched) {
          logAction(`ã“ã®è»è‰¦ã¯ã™ã§ã«æ´¾é£ä¸­ã§ã™ã€‚`);
          return;
      }
      const touristCode = document.getElementById('touristCodeInput').value;
      if (!touristCode) {
          logAction(`æ´¾é£å…ˆã®è¦³å…‰è€…ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
          return;
      }
      let targetIslandName;
      try {
          const jsonString = decodeURIComponent(atob(touristCode));
          const otherIslandData = JSON.parse(jsonString);
          targetIslandName = otherIslandData.islandName;
      } catch (e) {
          logAction(`ç„¡åŠ¹ãªè¦³å…‰è€…ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚`);
          return;
      }
      if (targetIslandName === islandName) {
          logAction(`æ¯æ¸¯ã¨åŒã˜å³¶ã«ã¯è»è‰¦ã‚’æ´¾é£ã§ãã¾ã›ã‚“ã€‚`);
          return;
      }
      const encodedWarshipData = encodeWarshipData(warship);
      const dispatchData = {
          type: "warshipDispatch",
          warshipData: encodedWarshipData,
          destinationIslandName: targetIslandName,
          sourceIslandName: islandName // æ´¾é£å…ƒã‚’è¨˜éŒ²
      };
      const encodedDispatchAction = btoa(encodeURIComponent(JSON.stringify(dispatchData)));
      document.getElementById('actionForOtherIslandOutput').value = encodedDispatchAction;
      warship.isDispatched = true; // æ´¾é£çŠ¶æ…‹ã«ã™ã‚‹
      warship.currentFuel = 0; // æ´¾é£ä¸­ã¯ç‡ƒæ–™0
      warship.currentAmmo = 0; // æ´¾é£ä¸­ã¯å¼¾è–¬0
      logAction(`è»è‰¦ã€Œ${warship.name}ã€ã‚’ã€Œ${targetIslandName}ã€ã¸æ´¾é£ã™ã‚‹è¨ˆç”»ã‚’ç«‹ã¦ã¾ã—ãŸã€‚`);
      logAction(`ä»–å³¶ã¸ã®è¡Œå‹•ãŒã€Œä»–å³¶ã¸ã®è¡Œå‹•ã€æ¬„ã«å‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚`);
  } else if (action === 'requestWarshipReturn') { // è»è‰¦å¸°é‚„è¦è«‹: ã‚³ãƒãƒ³ãƒ‰åå¤‰æ›´
      const warship = warships.find(ship => ship.x === selectedX && ship.y === selectedY);
      if (!warship) {
          logAction(`(${selectedX},${selectedY}) ã«è»è‰¦ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚`);
          return;
      }
      if (!warship.isDispatched) {
          logAction(`ã“ã®è»è‰¦ã¯æ´¾é£ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`);
          return;
      }
      if (warship.homePort !== islandName) {
          logAction(`ã“ã®è»è‰¦ã®æ¯æ¸¯ã¯${warship.homePort}ã§ã‚ã‚Šã€ã“ã®å³¶ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
          return;
      }
      const returnRequestData = {
          type: "warshipReturnRequest", // æ–°ã—ã„ã‚¿ã‚¤ãƒ—
          homePort: warship.homePort,
          name: warship.name // è¦è«‹ã™ã‚‹è»è‰¦ã‚’ç‰¹å®šã™ã‚‹æƒ…å ±
      };
      const encodedReturnRequestAction = btoa(encodeURIComponent(JSON.stringify(returnRequestData)));
      document.getElementById('actionForOtherIslandOutput').value = encodedReturnRequestAction;

      logAction(`è»è‰¦ã€Œ${warship.name}ã€ã®å¸°é‚„ã‚’è¦è«‹ã—ã¾ã—ãŸã€‚ä»–å³¶ã¸ã®è¡Œå‹•ãŒã€Œä»–å³¶ã¸ã®è¡Œå‹•ã€æ¬„ã«å‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚`);
      // ã“ã“ã§ã¯è»è‰¦ã®çŠ¶æ…‹ã¯å¤‰æ›´ã—ãªã„ï¼ˆç›¸æ‰‹å³¶ã‹ã‚‰ã®ç¢ºèªã‚’å¾…ã¤ï¼‰
  } else if (action === 'enhanceWarship') {
    if (!targetTileSelected) {
        logAction(`å¢—å¼·å¯¾è±¡ã®è»è‰¦ãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`);
        return;
    }
    const ship = warships.find(s => s.x === selectedX && s.y === selectedY);
    if (!ship) {
        logAction(`é¸æŠã—ãŸã‚¿ã‚¤ãƒ«ã«è»è‰¦ãŒã„ã¾ã›ã‚“ã€‚`);
        return;
    }

    const expCost = 200;
    if (ship.exp < expCost) {
        logAction(`${ship.name} ã®çµŒé¨“å€¤ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ï¼ˆ${expCost}EXP å¿…è¦ï¼‰`);
        return;
    }

    ship.exp -= expCost; // çµŒé¨“å€¤ã‚’æ¶ˆè²»

    let buffMessage = '';
    const rand = Math.random() * 100; // 0ã‹ã‚‰99.99...ã®ä¹±æ•°

    // ãƒãƒ•ã®ç¢ºç‡ã¨åŠ¹æœã‚’å®šç¾©
    if (rand < 35) { // 35%
        ship.maxFuel += 5;
        ship.fuel = Math.min(ship.fuel, ship.maxFuel); // ä¸Šé™ã‚’è¶…ãˆãªã„ã‚ˆã†ã«èª¿æ•´
        buffMessage = `ç‡ƒæ–™ä¸Šé™+5`;
    } else if (rand < 70) { // 35% + 35% = 70%
        ship.maxAmmo += 10;
        ship.ammo = Math.min(ship.ammo, ship.maxAmmo); // ä¸Šé™ã‚’è¶…ãˆãªã„ã‚ˆã†ã«èª¿æ•´
        buffMessage = `å¼¾è–¬åº«ä¸Šé™+10`;
    } else if (rand < 81) { // 70% + 11% = 81%
        ship.antiAir += 1;
        buffMessage = `å¯¾ç©ºç ²+1`;
    } else if (rand < 91) { // 81% + 10% = 91%
        ship.maxFuel += 10;
        ship.fuel = Math.min(ship.fuel, ship.maxFuel); // ä¸Šé™ã‚’è¶…ãˆãªã„ã‚ˆã†ã«èª¿æ•´
        buffMessage = `ç‡ƒæ–™ä¸Šé™+10`;
    } else if (rand < 95) { // 91% + 4% = 95%
        ship.maxDurability += 1;
        ship.currentDurability = Math.min(ship.currentDurability, ship.maxDurability); // ä¸Šé™ã‚’è¶…ãˆãªã„ã‚ˆã†ã«èª¿æ•´
        buffMessage = `è€ä¹…ä¸Šé™+1`;
    } else if (rand < 99) { // 95% + 4% = 99%
        ship.mainGun += 1;
        buffMessage = `ä¸»ç ²+1`;
    } else if (rand < 99.5) { // 99% + 0.5% = 99.5%
        ship.maxAmmo += 100;
        ship.ammo = Math.min(ship.ammo, ship.maxAmmo); // ä¸Šé™ã‚’è¶…ãˆãªã„ã‚ˆã†ã«èª¿æ•´
        buffMessage = `å¼¾è–¬åº«ä¸Šé™+100`;
    } else if (rand < 99.8) { // 99.5% + 0.3% = 99.8%
        ship.antiAir += 2;
        ship.maxDurability += 1;
        ship.currentDurability = Math.min(ship.currentDurability, ship.maxDurability);
        buffMessage = `å¯¾ç©º+2ï¼†è€ä¹…ä¸Šé™+1`;
    } else { // 99.8% + 0.2% = 100%
        ship.maxDurability += 3;
        ship.currentDurability = Math.min(ship.currentDurability, ship.maxDurability);
        ship.mainGun += 2;
        buffMessage = `è€ä¹…ä¸Šé™+3ï¼†ä¸»ç ²+2`;
    }

    logAction(`${ship.name} ã‚’å¢—å¼·ã—ã¾ã—ãŸï¼ ${buffMessage}ã‚’ç²å¾—ã€‚ç¾åœ¨ã®çµŒé¨“å€¤: ${ship.exp}`);
    renderMap();
    updateStatus();
    saveMyIslandState();
} else if (action === 'decommissionWarship') {
    if (!targetTileSelected) {
        logAction(`é™¤ç±å¯¾è±¡ã®è»è‰¦ãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`);
        return;
    }
    const shipIndex = warships.findIndex(s => s.x === selectedX && s.y === selectedY);
    const ship = warships[shipIndex];

    if (!ship) {
        logAction(`é¸æŠã—ãŸã‚¿ã‚¤ãƒ«ã«è»è‰¦ãŒã„ã¾ã›ã‚“ã€‚`);
        return;
    }

    // æœ€çµ‚ç¢ºèªã®ã‚¢ãƒ©ãƒ¼ãƒˆ
      const warship = warships.find(ship => ship.x === selectedX && ship.y === selectedY);
    const confirmation = confirm(`${ship.name} ã‚’é™¤ç±ã—ã¾ã™ãŒã€ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`);
      if (warship.homePort !== islandName) {
          logAction(`ã“ã®è»è‰¦ã®æ¯æ¸¯ã¯${warship.homePort}ã§ã‚ã‚Šã€ã“ã®å³¶ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
          return;
}if (confirmation) {
        // è»è‰¦ã‚’å‰Šé™¤
        warships.splice(shipIndex, 1);
        money += 1000000; // 1,000,000Gã‚’ç²å¾—

        logAction(`${ship.name} ã‚’é™¤ç±ã—ã€1,000,000Gã‚’ç²å¾—ã—ã¾ã—ãŸã€‚`);
        renderMap();
        updateStatus();
        saveMyIslandState();
    } else {
        logAction(`è»è‰¦ ${ship.name} ã®é™¤ç±ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚`);
    }
} else { // ãã®ä»–ã®ã‚¿ã‚¤ãƒ«é¸æŠãŒå¿…è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    actionQueue.push({ x: selectedX, y: selectedY, action });
    logAction(`(${selectedX},${selectedY}) ã« ${action} ã‚’è¨ˆç”»ã—ã¾ã—ãŸ`);
  }

  document.getElementById('actionSelect').value = "";
  updateConfirmButton();
}

// nextTurné–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§å®šç¾©
window.nextTurn = function () {
handleWarshipAttacks();
    warships.forEach(ship => {
        // è»è‰¦ãŒæ¯æ¸¯ã«ã„ã‚‹ï¼ˆæ´¾é£ä¸­ã§ãªãã€ã‹ã¤æ¯æ¸¯ã®åº§æ¨™ã«ã„ã‚‹ï¼‰å ´åˆ
        if (!ship.isDispatched && ship.x === ship.homeX && ship.y === ship.homeY) {
            // ã“ã“ã‚’ ship.currentDurability ã«ä¿®æ­£
            if (ship.currentDurability < ship.maxDurability) {
                ship.currentDurability = Math.min(ship.currentDurability + 1, ship.maxDurability);
                logAction(`${ship.name} ã¯æ¯æ¸¯ã§è€ä¹…åº¦ãŒ1å›å¾©ã—ã¾ã—ãŸã€‚ç¾åœ¨ã®è€ä¹…åº¦: ${ship.currentDurability}/${ship.maxDurability}`);
            }
        }
    });
  // ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã«ä»–å³¶ã‹ã‚‰ã®è¡Œå‹•ã‚’å‡¦ç†
  const otherIslandActionCode = document.getElementById('otherIslandActionInput').value;
  document.getElementById('otherIslandActionInput').value = ''; // å‡¦ç†ã—ãŸã‚‰ã‚¯ãƒªã‚¢
  if (otherIslandActionCode) {
      try {
          // æ–°ã—ã„ãƒ‡ã‚³ãƒ¼ãƒ‰æ–¹å¼
          const jsonString = decodeURIComponent(atob(otherIslandActionCode));
          const incomingAction = JSON.parse(jsonString);

          if ((incomingAction.type === 'bombard' || incomingAction.type === 'spreadBombard' || incomingAction.type === 'ppBombard') &&
              incomingAction.x !== undefined && incomingAction.y !== undefined && incomingAction.count !== undefined) {
              const { x, y, type, count } = incomingAction;
              let errorRange = 1; // ç ²æ’ƒã®èª¤å·®ç¯„å›²
              if (type === 'bombard') {
                  errorRange = 1;
              } else if (type === 'spreadBombard') {
                  errorRange = 2;
              } else if (type === 'ppBombard') {
                  errorRange = 0; // èª¤å·®ãªã—
              }

              logAction(`ä»–å³¶ã‹ã‚‰ ${count}ç™ºã®${type === 'bombard' ? 'ç ²æ’ƒ' : type === 'spreadBombard' ? 'æ‹¡æ•£å¼¾ç ²æ’ƒ' : 'PPå¼¾ç ²æ’ƒ'}ã‚’å—ã‘ã¾ã—ãŸï¼`);
              for (let i = 0; i < count; i++) {
                  let dx = 0;
                  let dy = 0;
                  if (errorRange > 0) {
                      dx = Math.floor(Math.random() * (2 * errorRange + 1)) - errorRange;
                      dy = Math.floor(Math.random() * (2 * errorRange + 1)) - errorRange;
                  }
                  const tx = x + dx;
                  const ty = y + dy;

                  if (tx >= 0 && ty >= 0 && tx < SIZE && ty < SIZE) {
                      const protectingFacility = getProtectingDefenseFacility(tx, ty); // å¤‰æ›´ç‚¹

                      if (protectingFacility) { // é˜²è¡›æ–½è¨­ãŒã‚ã£ãŸå ´åˆ
                          if (type === 'ppBombard') { // PPå¼¾ã ã£ãŸå ´åˆ
                              protectingFacility.facility = null; // é˜²è¡›æ–½è¨­ã‚’ç ´å£Š
                              protectingFacility.terrain = 'waste'; // é˜²è¡›æ–½è¨­ã®å ´æ‰€ã‚’è’åœ°ã«ã™ã‚‹
                              protectingFacility.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
                              logAction(`(${tx},${ty}) ã‚’å®ˆã£ã¦ã„ãŸé˜²è¡›æ–½è¨­ãŒPPå¼¾ã«ã‚ˆã‚Šç ´å£Šã•ã‚Œã¾ã—ãŸï¼`);
                              // ãã®å¾Œã€PPå¼¾ã®åŠ¹æœã‚’é©ç”¨ï¼ˆæ—¢å­˜ã®æ”»æ’ƒãƒ­ã‚¸ãƒƒã‚¯ã«æµã‚Œã‚‹ï¼‰
                          } else { // PPå¼¾ã§ãªã‘ã‚Œã°é˜²è¡›æ–½è¨­ãŒå®ˆã‚‹
                              logAction(`ç ²æ’ƒã¯é˜²è¡›æ–½è¨­ã«ã‚ˆã‚Šç„¡åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ (${tx},${ty})`);
                              continue; // æ¬¡ã®æ”»æ’ƒã¸
                          }
                      }
                      // é˜²è¡›æ–½è¨­ãŒç ´å£Šã•ã‚ŒãŸã‹ã€å…ƒã€…å­˜åœ¨ã—ãªã„å ´åˆã€ä»¥ä¸‹ã®æ”»æ’ƒãƒ­ã‚¸ãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã‚‹
                      const target = map[ty][tx];
                      if (target.terrain === 'sea') {
                          if (target.facility === 'port') {
                              target.facility = null;
                              logAction(`ä»–å³¶ã‹ã‚‰ã®ç ²æ’ƒã«ã‚ˆã‚Š (${tx},${ty}) ã®æ¸¯ãŒç ´å£Šã•ã‚Œã¾ã—ãŸ`);
                          } else {
                              // è»è‰¦ã¸ã®ç€å¼¾åˆ¤å®š
                              const targetWarship = warships.find(ship => ship.x === tx && ship.y === ty);
                              if (targetWarship) {
                                  // æ´¾é£ä¸­ã®è»è‰¦ã¸ã®æ”»æ’ƒã¯ç„¡åŠ¹
                                  if (targetWarship.isDispatched) {
                                      logAction(`æ´¾é£ä¸­ã®è»è‰¦ã€Œ${targetWarship.name}ã€ã¸ã®ç ²æ’ƒã¯ç„¡åŠ¹ã§ã—ãŸã€‚`);
                                      continue;
                                  }
                                  targetWarship.currentDurability -= 1; // è€ä¹…å€¤1æ¸›å°‘
                                  if (targetWarship.currentDurability <= 0) {
                                      warships = warships.filter(ship => ship !== targetWarship);
                            targetWarship.currentDurability = 0; // 0ä»¥ä¸‹ã«ãªã‚‰ãªã„ã‚ˆã†ã«
                            targetWarship.fuel = 0; // æ®‹ã‚Šç‡ƒæ–™ã‚’0ã«
                            targetWarship.currentFuel = 0; // ç¾åœ¨ç‡ƒæ–™ã‚‚0ã«
                            targetWarship.ammo = 0; // æ®‹ã‚Šå¼¾è–¬ã‚’0ã«
                            targetWarship.currentAmmo = 0; // ç¾åœ¨å¼¾è–¬ã‚‚0ã«
                                      logAction(`ä»–å³¶ã‹ã‚‰ã®ç ²æ’ƒã«ã‚ˆã‚Šè»è‰¦ã€Œ${targetWarship.name}ã€ãŒæ’ƒæ²ˆã•ã‚Œã¾ã—ãŸï¼`);
                                  } else {
                                      logAction(`ä»–å³¶ã‹ã‚‰ã®ç ²æ’ƒãŒè»è‰¦ã€Œ${targetWarship.name}ã€ã«ç€å¼¾ã—ã¾ã—ãŸï¼ (æ®‹ã‚Šè€ä¹…: ${targetWarship.currentDurability})`);
                                  }
                              } else {
                                  logAction(`ä»–å³¶ã‹ã‚‰ã®ç ²æ’ƒã¯æµ·ã«ç€å¼¾ã—ã¾ã—ãŸ (${tx},${ty})`);
                              }
                          }
                      } else { // é™¸åœ°ã®å ´åˆ
                          if (target.facility) {
                              if (target.facility === 'house') {
                                  population -= target.pop;
                                  if (population < 0) population = 0;
                              }
                              target.facility = null;
                              target.enhanced = false; // æ–½è¨­ç ´å£Šæ™‚ã«å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
                          }
                          target.terrain = 'waste';
                          logAction(`ä»–å³¶ã‹ã‚‰ã®ç ²æ’ƒã«ã‚ˆã‚Š (${tx},${ty}) ãŒç ´å£Šã•ã‚Œã¾ã—ãŸ`);
                      }
                  } else {
                      logAction(`ä»–å³¶ã‹ã‚‰ã®ç ²æ’ƒã¯é ˜åŸŸå¤–ã«ç€å¼¾ã—ã¾ã—ãŸ (${tx},${ty})`);
                  }
              }
          } else if (incomingAction.type === 'warshipDispatch') { // è»è‰¦æ´¾é£ã®å—ä¿¡å‡¦ç†
              const { warshipData, sourceIslandName } = incomingAction;
              const newWarship = decodeWarshipData(warshipData);

              // é©åˆ‡ãªæµ·åŸŸã‚’æ¢ã—ã¦é…ç½®
              const possibleSeaTiles = [];
              for (let y = 0; y < SIZE; y++) {
                  for (let x = 0; x < SIZE; x++) {
                      const tile = map[y][x];
                      const existingWarship = warships.find(ship => ship.x === x && ship.y === y);
                      if (tile.terrain === 'sea' && tile.facility === null && !existingWarship) {
                          possibleSeaTiles.push({ x, y });
                      }
                  }
              }

              if (possibleSeaTiles.length > 0) {
                  const randomIndex = Math.floor(Math.random() * possibleSeaTiles.length);
                  const { x, y } = possibleSeaTiles[randomIndex];
                  newWarship.x = x;
                  newWarship.y = y;
                  newWarship.isDispatched = false; // æ´¾é£ã•ã‚ŒãŸè»è‰¦ã¯ã€ãã®å³¶ã§ã¯æ´¾é£ä¸­ã§ã¯ãªã„
                  warships.push(newWarship);
                  logAction(`ã€Œ${sourceIslandName}ã€ã‹ã‚‰è»è‰¦ã€Œ${newWarship.name}ã€ãŒæ´¾é£ã•ã‚Œã¾ã—ãŸï¼ (${x},${y}) ã«åˆ°ç€ã€‚`);
              } else {
                  logAction(`ã€Œ${sourceIslandName}ã€ã‹ã‚‰æ´¾é£ã•ã‚ŒãŸè»è‰¦ã€Œ${newWarship.name}ã€ã¯é…ç½®ã§ãã‚‹æµ·åŸŸãŒãªãã€å¸°é‚„ã—ã¾ã—ãŸã€‚`);
              }
          } else if (incomingAction.type === 'warshipReturnRequest') {
              const { homePort, name } = incomingAction;
              const warshipToReturn = warships.find(ship =>
                  ship.homePort === homePort &&
                  ship.name === name &&
                  !ship.isDispatched // ã“ã®å³¶ã§ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªï¼ˆæ´¾é£ä¸­ã§ãªã„ï¼‰è»è‰¦
              );

              if (warshipToReturn) {
                  // æœ€æ–°ã®è»è‰¦æƒ…å ±ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
                  const encodedWarshipData = encodeWarshipData(warshipToReturn);
                  const returnConfirmationData = {
                      type: "warshipReturnConfirmation", // å¸°é‚„ç¢ºèªã‚¿ã‚¤ãƒ—
                      warshipData: encodedWarshipData,
                      originalHomePort: warshipToReturn.homePort
                  };
                  const encodedReturnConfirmationAction = btoa(encodeURIComponent(JSON.stringify(returnConfirmationData)));
                  document.getElementById('actionForOtherIslandOutput').value = encodedReturnConfirmationAction;

                  // è»è‰¦ã‚’ã“ã®å³¶ã‹ã‚‰å‰Šé™¤
                  warships = warships.filter(ship => ship !== warshipToReturn);
                  logAction(`è»è‰¦ã€Œ${warshipToReturn.name}ã€(${warshipToReturn.homePort}ç±) ã®å¸°é‚„è¦è«‹ã‚’å—ã‘ã€è¿”é€ã‚³ãƒ¼ãƒ‰ã‚’å‡ºåŠ›ã—ã€è‡ªå³¶ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
              } else {
                  logAction(`å¸°é‚„è¦è«‹ã•ã‚ŒãŸè»è‰¦ã€Œ${name}ã€(${homePort}ç±) ã¯ã€ã“ã®å³¶ã«ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã§ã—ãŸã€‚`);
              }
          } else if (incomingAction.type === 'warshipReturnConfirmation') { // è»è‰¦å¸°é‚„ç¢ºèªã®å—ä¿¡å‡¦ç† (æ¯æ¸¯å´)
              const { warshipData, originalHomePort } = incomingAction;
              const returnedWarshipData = decodeWarshipData(warshipData);

              // æ¯æ¸¯: è©²å½“ã™ã‚‹æ´¾é£ä¸­ã®è»è‰¦ã‚’æ¢ã—ã¦æƒ…å ±ã‚’æ›´æ–°ã—ã€æ´¾é£çŠ¶æ…‹ã‚’è§£é™¤
              const existingWarship = warships.find(ship =>
                  ship.homePort === returnedWarshipData.homePort &&
                  ship.name === returnedWarshipData.name &&
                  ship.isDispatched === true // æ¯æ¸¯ã§æ´¾é£ä¸­ã¨ãƒãƒ¼ã‚¯ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®
              );

              if (existingWarship) {
                  // æœ€æ–°ã®è»è‰¦æƒ…å ±ã«æ›¸ãæ›ãˆã‚‹
                  existingWarship.exp = returnedWarshipData.exp;
                  existingWarship.currentFuel = returnedWarshipData.currentFuel;
                  existingWarship.maxFuel = returnedWarshipData.maxFuel; // maxFuelã‚‚æ›´æ–°
                  existingWarship.currentDurability = returnedWarshipData.currentDurability;
                  existingWarship.mainGun = returnedWarshipData.mainGun;
                  existingWarship.torpedo = returnedWarshipData.torpedo;
                  existingWarship.antiAir = returnedWarshipData.antiAir;
                  existingWarship.maxAmmo = returnedWarshipData.maxAmmo;
                  existingWarship.currentAmmo = returnedWarshipData.currentAmmo;
                  existingWarship.reconnaissance = returnedWarshipData.reconnaissance;
                  existingWarship.accuracyImprovement = returnedWarshipData.accuracyImprovement;

                  existingWarship.isDispatched = false; // æ´¾é£çŠ¶æ…‹ã‚’è§£é™¤

                  logAction(`è»è‰¦ã€Œ${existingWarship.name}ã€ãŒæ¯æ¸¯ã€Œ${originalHomePort}ã€ã«å¸°é‚„ã—ã¾ã—ãŸï¼æƒ…å ±ãŒæ›´æ–°ã•ã‚Œã€æ´¾é£çŠ¶æ…‹ãŒè§£é™¤ã•ã‚Œã¾ã—ãŸã€‚`);
              } else {
                  logAction(`å¸°é‚„ã—ãŸè»è‰¦ã€Œ${returnedWarshipData.name}ã€ã¯ã€ã“ã®å³¶ã§å¯¾å¿œã™ã‚‹æ´¾é£ä¸­ã®è»è‰¦ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
              }
          }
      } catch (e) {
          logAction("ä»–å³¶ã‹ã‚‰ã®è¡Œå‹•ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          console.error(e);
      }
  }


  // å¿…ãšè‡ªåˆ†ã®å³¶ã«æˆ»ã‚‹
  if (isViewingOtherIsland) {
      loadMyIslandState(); // è‡ªåˆ†ã®å³¶ã«æˆ»ã‚‹
      document.getElementById('actionForOtherIslandOutput').value = ''; // ä»–å³¶ã¸ã®è¡Œå‹•ã‚’ã‚¯ãƒªã‚¢
      logAction("ã‚¿ãƒ¼ãƒ³ãŒé€²ã‚“ã ãŸã‚ã€è‡ªå³¶ã«æˆ»ã‚Šã¾ã—ãŸã€‚");
  }


  // è‡ªåˆ†ã®å³¶ã®ã‚¿ãƒ¼ãƒ³å‡¦ç†
  turn++;
  let foodChange = 0, moneyChange = 0;
  let prevPopulation = population; // å‰ã‚¿ãƒ¼ãƒ³ã®äººå£ã‚’ä¿å­˜
  let currentTurnPopulationGrowth = 0; // ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ã§ã®äººå£å¢—åŠ ã‚’ãƒªã‚»ãƒƒãƒˆ

  // è¡Œå‹•ã‚­ãƒ¥ãƒ¼ã®å‡¦ç† (æœ€å¤§2ã¤ã¾ã§å®Ÿè¡Œ)
  const actionsToExecute = actionQueue.splice(0, Math.min(actionQueue.length, 2));

  for (const task of actionsToExecute) {
    const { x, y, action } = task;
    let tile = null;
    if (x !== null && y !== null) {
      tile = map[y][x];
    }else if (action === 'buildWarship') {
  const { warshipData } = task;
  const existingWarship = warships.find(ship => ship.x === x && ship.y === y);
  if (existingWarship) {
    logAction(`(${x},${y}) ã«ã¯æ—¢ã«è»è‰¦ãŒå­˜åœ¨ã™ã‚‹ãŸã‚ã€å»ºé€ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
    continue;
  }

const newWarship = {
        x: selectedX,
        y: selectedY,
        homePort: islandName,
        name: document.getElementById('warshipName').value || "ç„¡éŠ˜è‰¦",
        exp: 0,
        currentFuel: Math.min(WARSHIP_CAPS.maxFuel, 100), // åˆæœŸç‡ƒæ–™ã‚‚ä¸Šé™è€ƒæ…®
        maxFuel: Math.min(WARSHIP_CAPS.maxFuel, 100), // åˆæœŸæœ€å¤§ç‡ƒæ–™ã‚‚ä¸Šé™è€ƒæ…®
        maxDurability: Math.min(WARSHIP_CAPS.maxDurability, parseInt(document.getElementById('warshipDurability').value)),
        currentDurability: Math.min(WARSHIP_CAPS.maxDurability, parseInt(document.getElementById('warshipDurability').value)),
        mainGun: Math.min(WARSHIP_CAPS.mainGun, parseInt(document.getElementById('warshipMainGun').value)),
        torpedo: parseInt(document.getElementById('warshipTorpedo').value), // é­šé›·ã«ã¯ä¸Šé™ãªã—
        antiAir: Math.min(WARSHIP_CAPS.antiAir, parseInt(document.getElementById('warshipAntiAir').value)),
        maxAmmo: Math.min(WARSHIP_CAPS.maxAmmo, parseInt(document.getElementById('warshipAmmo').value)),
        currentAmmo: Math.min(WARSHIP_CAPS.maxAmmo, parseInt(document.getElementById('warshipAmmo').value)),
        reconnaissance: parseInt(document.getElementById('warshipRecon').value),
        accuracyImprovement: parseInt(document.getElementById('warshipAccuracy').value),
        isDispatched: false, // æ´¾é£çŠ¶æ…‹
        originalCost: totalCost // å»ºé€ ã‚³ã‚¹ãƒˆã‚’ä¿å­˜
    };
  warships.push(newWarship);
  money -= warshipData.originalCost;
        map[currentAction.y][currentAction.x].facility = 'warship'; // åœ°å›³ã‚¿ã‚¤ãƒ«ã«è»è‰¦ãŒå»ºè¨­ã•ã‚ŒãŸã“ã¨ã‚’è¨˜éŒ²
  logAction(`(${x},${y}) ã«è»è‰¦ã€Œ${newWarship.name}ã€ã‚’å»ºé€ ã—ã¾ã—ãŸã€‚`);
}

    // ä½å®…ã®ä¸Šã«å»ºè¨­ã™ã‚‹éš›ã®å‡¦ç†ã‚’å…±é€šåŒ–
    const handleHouseOverwrite = (targetTile) => {
        if (targetTile && targetTile.facility === 'house') {
            population -= targetTile.pop;
            if (population < 0) population = 0;
            targetTile.facility = null;
            targetTile.pop = 0;
            logAction(`(${x},${y}) ã®ä½å®…ãŒå–ã‚Šå£Šã•ã‚Œã¾ã—ãŸã€‚`);
        }
    };

    if (action === 'buildFarm') {
      if (tile && tile.terrain === 'plain' && money >= 100) {
        handleHouseOverwrite(tile);
        tile.facility = 'farm';
        tile.enhanced = false; // æ–°è¦å»ºè¨­ã¯å¼·åŒ–ãªã—
        money -= 100;
        logAction(`(${x},${y}) ã«è¾²å ´ã‚’å»ºè¨­ã—ã¾ã—ãŸ`);
      } else logAction(`(${x},${y}) ã®è¾²å ´å»ºè¨­ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
    }
    else if (action === 'buildFactory') {
      if (tile && tile.terrain === 'plain' && money >= 100) {
        handleHouseOverwrite(tile);
        tile.facility = 'factory';
        tile.enhanced = false; // æ–°è¦å»ºè¨­ã¯å¼·åŒ–ãªã—
        money -= 100;
        logAction(`(${x},${y}) ã«å·¥å ´ã‚’å»ºè¨­ã—ã¾ã—ãŸ`);
      } else logAction(`(${x},${y}) ã®å·¥å ´å»ºè¨­ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
    }
    else if (action === 'flatten') {
      if (tile && (tile.terrain === 'waste' || tile.facility) && money >= 20) {
        money -= 20;
        if (tile.facility === 'house') {
            population -= tile.pop; // äººå£ã‚’å³æ™‚åæ˜ 
            if (population < 0) population = 0;
        }
        tile.terrain = 'plain'; tile.facility = null; tile.pop = 0; tile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
        logAction(`(${x},${y}) ã‚’æ•´åœ°ã—ã¦å¹³åœ°ã«ã—ã¾ã—ãŸ`);
      } else logAction(`(${x},${y}) ã®æ•´åœ°ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
    }
    else if (action === 'buildMonument'){
      if (tile && tile.terrain === 'plain' && tile.facility != 'Monument' && money >= 500000000) {
        handleHouseOverwrite(tile);
        tile.facility = 'Monument';
        money -= 500000000;
        tile.MonumentLevel = 1;
        logAction(`(${x},${y}) ã«çŸ³ç¢‘ã‚’å»ºè¨­ã—ã¾ã—ãŸ`);
      } else {
        logAction(`(${x},${y}) ã®çŸ³ç¢‘å»ºè¨­ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
      }
    }
    else if (action === 'upgradeMonument')
      if (tile && tile.facility === 'Monument' && money >= 500000000) {
        handleHouseOverwrite(tile);
        tile.MonumentLevel += 1;
        money -= 500000000;
        logAction(`(${x},${y}) ã®çŸ³ç¢‘ã‚’å¼·åŒ–ã—ã¾ã—ãŸ`);
      } else {
        logAction(`(${x},${y}) ã®çŸ³ç¢‘å¼·åŒ–ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
      }
    else if (action === 'sellMonument')
      if (tile && tile.facility === 'Monument') {
        handleHouseOverwrite(tile);
        tile.terrain = 'plain'; tile.facility = null; tile.pop = 0; tile.enhanced = false
        money += 500000000 * tile.MonumentLevel;
        tile.MonumentLevel = 0;
        logAction(`(${x},${y}) ã®çŸ³ç¢‘ã‚’å£²å´ã—ã¾ã—ãŸ`);
      } else {
        logAction(`(${x},${y}) ã®çŸ³ç¢‘å£²å´ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
      }
    else if (action === 'cutForest') {
      if (tile && tile.terrain === 'forest') {
        const gain = Math.floor(Math.random() * 421) + 80;
        money += gain; tile.terrain = 'plain'; tile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
        logAction(`(${x},${y}) ã‚’ä¼æ¡ã— ${gain}G ã‚’å¾—ã¾ã—ãŸ`);
      } else logAction(`(${x},${y}) ã®ä¼æ¡ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ£®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰`);
    }
    else if (action === 'plantForest') {
      if (tile && tile.terrain === 'plain' && money >= 200) {
        handleHouseOverwrite(tile);
        tile.terrain = 'forest';
        tile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
        money -= 200;
        logAction(`(${x},${y}) ã«æ¤æ—ã‚’è¡Œã„ã€æ£®ã«ã—ã¾ã—ãŸ`);
      } else {
        logAction(`(${x},${y}) ã®æ¤æ—ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
      }
    }
    else if (action === 'buildGun') {
      if (tile && tile.terrain === 'plain' && money >= 1200) {
        handleHouseOverwrite(tile);
        tile.facility = 'gun'; money -= 1200; tile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
        logAction(`(${x},${y}) ã«ç ²å°ã‚’å»ºè¨­ã—ã¾ã—ãŸ`);
      } else logAction(`(${x},${y}) ã®ç ²å°å»ºè¨­ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
    }
    else if (action === 'buildDefenseFacility') { // é˜²è¡›æ–½è¨­å»ºè¨­
      if (tile && tile.terrain === 'plain' && money >= 5000) {
        handleHouseOverwrite(tile);
        tile.facility = 'defenseFacility';
        money -= 5000;
        tile.enhanced = false; // æ–°è¦å»ºè¨­ã¯å¼·åŒ–ãªã—
        logAction(`(${x},${y}) ã«é˜²è¡›æ–½è¨­ã‚’å»ºè¨­ã—ã¾ã—ãŸ`);
      } else logAction(`(${x},${y}) ã®é˜²è¡›æ–½è¨­å»ºè¨­ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
    }
    else if (action === 'landfill') {
      if (tile && tile.terrain === 'sea' && money >= 600) {
        tile.terrain = 'waste'; money -= 600; tile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
        logAction(`(${x},${y}) ã‚’åŸ‹ã‚ç«‹ã¦ã¦è’åœ°ã«ã—ã¾ã—ãŸ`);
      } else logAction(`(${x},${y}) ã®åŸ‹ã‚ç«‹ã¦ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæµ·ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
    }
    else if (action === 'exportFood') {
      const amount = task.amount;
      if (food >= amount * 20) {
        food -= amount * 20; money += amount * 200;
        logAction(`é£Ÿæ–™ã‚’ ${amount * 20} è¼¸å‡ºã— ${amount * 200}G ã‚’å¾—ã¾ã—ãŸ`);
      } else logAction(`é£Ÿæ–™è¼¸å‡ºã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé£Ÿæ–™ä¸è¶³ï¼‰`);
    }
    else if (action === 'buildPort') {
      if (tile && tile.terrain === 'sea' && !tile.facility && money >= 3000) {
        let adjacentLand = false;
        for (let dx = -1; dx <= 1; dx++) {
          for (let dy = -1; dy <= 1; dy++) {
            const nx = x + dx, ny = y + dy;
            if (nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE && (dx !== 0 || dy !== 0) && map[ny][nx].terrain !== 'sea') {
              adjacentLand = true;
              break;
            }
          }
          if (adjacentLand) break;
        }
        if (adjacentLand) {
          tile.facility = 'port'; money -= 3000; tile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
          logAction(`(${x},${y}) ã«æ¸¯ã‚’å»ºè¨­ã—ã¾ã—ãŸ`);
        } else logAction(`(${x},${y}) ã®æ¸¯å»ºè¨­ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆé™¸åœ°ã«éš£æ¥ã—ã¦ã„ã¾ã›ã‚“ã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
      } else logAction(`(${x},${y}) ã®æ¸¯å»ºè¨­ã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¡ä»¶ä¸é©åˆã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
    }
    else if (action === 'dig') {
      if (tile && tile.terrain !== 'sea' && money >= 300) {
        if (tile.facility === 'house') { // ä½å®…ã«æ˜å‰Šã‚’è¡Œã£ãŸå ´åˆã®äººå£æ¸›å°‘
            population -= tile.pop;
            if (population < 0) population = 0;
        }
        tile.terrain = 'sea'; tile.facility = null; tile.pop = 0; tile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
        money -= 300;
        logAction(`(${x},${y}) ã‚’æ˜å‰Šã—ã¦æµ·ã«ã—ã¾ã—ãŸ`);
      } else logAction(`(${x},${y}) ã®æ˜å‰Šã¯å¤±æ•—ã—ã¾ã—ãŸï¼ˆæµ·ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã¾ãŸã¯è³‡é‡‘ä¸è¶³ï¼‰`);
    }
    else if (action === 'bombard' || action === 'spreadBombard' || action === 'ppBombard') {
      const count = task.count || 1;
      const guns = map.flat().filter(t => t.facility === 'gun').length;
      let costPerShot = 0;
      let errorRange = 1; // ç ²æ’ƒã®èª¤å·®ç¯„å›²
      if (action === 'bombard') {
          costPerShot = 120;
          errorRange = 1;
      } else if (action === 'spreadBombard') {
          costPerShot = 500;
          errorRange = 2;
      } else if (action === 'ppBombard') {
          costPerShot = 10000000; // PPå¼¾ã®ä¾¡æ ¼ã‚’æ›´æ–°
          errorRange = 0; // èª¤å·®ãªã—
      }

      const usableGuns = Math.min(count, guns, Math.floor(money / costPerShot));

      if (usableGuns > 0) {
        let hits = 0;
        for (let i = 0; i < usableGuns; i++) {
          let dx = 0;
          let dy = 0;
          if (errorRange > 0) {
            dx = Math.floor(Math.random() * (2 * errorRange + 1)) - errorRange;
            dy = Math.floor(Math.random() * (2 * errorRange + 1)) - errorRange;
          }
          const tx = x + dx;
          const ty = y + dy;

          if (tx >= 0 && ty >= 0 && tx < SIZE && ty < SIZE) {
            const protectingFacility = getProtectingDefenseFacility(tx, ty); // å¤‰æ›´ç‚¹

            if (protectingFacility) { // é˜²è¡›æ–½è¨­ãŒã‚ã£ãŸå ´åˆ
                if (action === 'ppBombard') { // PPå¼¾ã ã£ãŸå ´åˆ
                    protectingFacility.facility = null; // é˜²è¡›æ–½è¨­ã‚’ç ´å£Š
                    protectingFacility.terrain = 'waste'; // é˜²è¡›æ–½è¨­ã®å ´æ‰€ã‚’è’åœ°ã«ã™ã‚‹
                    protectingFacility.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
                    logAction(`(${tx},${ty}) ã‚’å®ˆã£ã¦ã„ãŸé˜²è¡›æ–½è¨­ãŒPPå¼¾ã«ã‚ˆã‚Šç ´å£Šã•ã‚Œã¾ã—ãŸï¼`);
                    // ãã®å¾Œã€PPå¼¾ã®åŠ¹æœã‚’é©ç”¨ï¼ˆæ—¢å­˜ã®æ”»æ’ƒãƒ­ã‚¸ãƒƒã‚¯ã«æµã‚Œã‚‹ï¼‰
                } else { // PPå¼¾ã§ãªã‘ã‚Œã°é˜²è¡›æ–½è¨­ãŒå®ˆã‚‹
                    logAction(`ç ²æ’ƒã¯é˜²è¡›æ–½è¨­ã«ã‚ˆã‚Šç„¡åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ (${tx},${ty})`);
                    continue; // æ¬¡ã®æ”»æ’ƒã¸
                }
            }
            // é˜²è¡›æ–½è¨­ãŒç ´å£Šã•ã‚ŒãŸã‹ã€å…ƒã€…å­˜åœ¨ã—ãªã„å ´åˆã€ä»¥ä¸‹ã®æ”»æ’ƒãƒ­ã‚¸ãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã‚‹
            const target = map[ty][tx];
            if (target.terrain === 'sea') {
                if (target.facility === 'port') {
                    target.facility = null;
                    logAction(`ç ²æ’ƒã§ (${tx},${ty}) ã®æ¸¯ã‚’ç ´å£Šã—ã€æµ·ã«ãªã‚Šã¾ã—ãŸ`);
                } else {
                    // è»è‰¦ã¸ã®ç€å¼¾åˆ¤å®š
                    const targetWarship = warships.find(ship => ship.x === tx && ship.y === ty);
                    if (targetWarship) {
                        // æ´¾é£ä¸­ã®è»è‰¦ã¸ã®æ”»æ’ƒã¯ç„¡åŠ¹
                        if (targetWarship.isDispatched) {
                            logAction(`æ´¾é£ä¸­ã®è»è‰¦ã€Œ${targetWarship.name}ã€ã¸ã®ç ²æ’ƒã¯ç„¡åŠ¹ã§ã—ãŸã€‚`);
                            continue;
                        }
                        targetWarship.currentDurability -= 1; // è€ä¹…å€¤1æ¸›å°‘
                        if (targetWarship.currentDurability <= 0) {
                            warships = warships.filter(ship => ship !== targetWarship);
                            targetWarship.currentDurability = 0; // 0ä»¥ä¸‹ã«ãªã‚‰ãªã„ã‚ˆã†ã«
                            targetWarship.fuel = 0; // æ®‹ã‚Šç‡ƒæ–™ã‚’0ã«
                            targetWarship.currentFuel = 0; // ç¾åœ¨ç‡ƒæ–™ã‚‚0ã«
                            targetWarship.ammo = 0; // æ®‹ã‚Šå¼¾è–¬ã‚’0ã«
                            targetWarship.currentAmmo = 0; // ç¾åœ¨å¼¾è–¬ã‚‚0ã«
                            logAction(`ç ²æ’ƒã«ã‚ˆã‚Šè»è‰¦ã€Œ${targetWarship.name}ã€ãŒæ’ƒæ²ˆã•ã‚Œã¾ã—ãŸï¼`);
                        } else {
                            logAction(`ç ²æ’ƒãŒè»è‰¦ã€Œ${targetWarship.name}ã€ã«ç€å¼¾ã—ã¾ã—ãŸï¼ (æ®‹ã‚Šè€ä¹…: ${targetWarship.currentDurability})`);
                        }
                    } else {
                        logAction(`ç ²æ’ƒã¯æµ·ã«ç€å¼¾ã—ã¾ã—ãŸ (${tx},${ty})`);
                    }
                }
            } else { // é™¸åœ°ã®å ´åˆ
                if (target.facility) {
                    if (target.facility === 'house') {
                        population -= target.pop;
                        if (population < 0) population = 0;
                    }
                }
                    target.facility = null;
                    target.enhanced = false; // æ–½è¨­ç ´å£Šæ™‚ã«å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
                target.terrain = 'waste';
                logAction(`ç ²æ’ƒã§ (${tx},${ty}) ã‚’ç ´å£Šã—ã¾ã—ãŸ`);
            }

            // æ€ªç£ãŒå‘½ä¸­ã—ãŸã‹ãƒã‚§ãƒƒã‚¯
            if (monster && monster.x === tx && monster.y === ty) {
              monster = null;
              logAction(`æ€ªç£ãŒç ²æ’ƒã«ã‚ˆã‚Šè¨ä¼ã•ã‚Œã¾ã—ãŸâ€¼`);
            }
            hits++;
          } else {
            logAction(`ç ²æ’ƒã¯é ˜åŸŸå¤–ã«ç€å¼¾ã—ã¾ã—ãŸ (${tx},${ty})`);
          }
        }
        money -= hits * costPerShot; // æˆåŠŸã—ãŸç ²æ’ƒã®æ•°ã ã‘è²»ç”¨ã‚’å¼•ã
      } else {
        logAction(`ç ²æ’ƒã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚`);
      }
    }
    else if (action === 'selfDestructMilitaryFacility') { // åç§°å¤‰æ›´
        if (tile && (tile.facility === 'gun' || tile.facility === 'defenseFacility')) { // ãƒãƒªãƒœãƒ†æ–½è¨­ã‚’å‰Šé™¤
            tile.facility = null;
            tile.terrain = 'sea';
            tile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
            logAction(`(${x},${y}) ã®è»äº‹æ–½è¨­ãŒè‡ªçˆ†ã—ã€æµ·ã«ãªã‚Šã¾ã—ãŸã€‚`);

            // å‘¨å›²1ãƒã‚¹ã‚’è’åœ°ã«ã™ã‚‹
            for (let dx = -1; dx <= 1; dx++) {
                for (let dy = -1; dy <= 1; dy++) {
                    const nx = x + dx;
                    const ny = y + dy;
                    if (nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE && !(dx === 0 && dy === 0)) {
                        const affectedTile = map[ny][nx];
                        if (affectedTile.terrain !== 'sea') { // æµ·ä»¥å¤–ã®åœ°å½¢ã‚’è’åœ°ã«ã™ã‚‹
                            if (affectedTile.facility === 'house') {
                                population -= affectedTile.pop;
                                if (population < 0) population = 0;
                            }
                            affectedTile.terrain = 'waste';
                            affectedTile.facility = null;
                            affectedTile.pop = 0;
                            affectedTile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
                            logAction(`(${nx},${ny}) ãŒè»äº‹æ–½è¨­è‡ªçˆ†ã«ã‚ˆã‚Šè’åœ°ã«ãªã‚Šã¾ã—ãŸã€‚`);
                        }
                    }
                }
            }
        } else {
            logAction(`(${x},${y}) ã«è»äº‹æ–½è¨­ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
        }
    }
    else if (action === 'enhanceFacility') { // è¨­å‚™å¼·åŒ–
        if (tile && (tile.facility === 'farm' || tile.facility === 'factory') && !tile.enhanced && money >= 10000) {
            tile.enhanced = true;
            money -= 10000;
            logAction(`(${x},${y}) ã®${tile.facility === 'farm' ? 'è¾²å ´' : 'å·¥å ´'}ãŒå¼·åŒ–ã•ã‚Œã¾ã—ãŸã€‚`);
        } else {
            logAction(`(${x},${y}) ã®è¨­å‚™å¼·åŒ–ã¯å¤±æ•—ã—ã¾ã—ãŸã€‚`);
        }
    } else if (action === 'buildWarship') { // è»è‰¦å»ºé€ 
        const { name, durability, mainGun, torpedo, antiAir, ammo, recon, accuracy, cost } = task.warshipData;

        // å†åº¦ã€å ´æ‰€ã¨è²»ç”¨ã‚’ç¢ºèª
        let adjacentToPort = false;
        for (let dx = -1; dx <= 1; dx++) {
            for (let dy = -1; dy <= 1; dy++) {
                const nx = x + dx;
                const ny = y + dy;
                if (nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE && (dx !== 0 || dy !== 0)) {
                    if (map[ny][nx].facility === 'port') {
                        adjacentToPort = true;
                        break;
                    }
                }
            }
            if (adjacentToPort) break;
        }
        // Check if a warship already exists at the selected tile
        const existingWarship = warships.find(ship => ship.x === x && ship.y === y);

            const newWarship = {
                x: x,
                y: y,
                homePort: islandName,
                name: name,
                exp: 0,
                currentFuel: 0, // åˆæœŸç‡ƒæ–™0
                maxFuel: 100, // ä»®ã®æœ€å¤§ç‡ƒæ–™
                maxDurability: durability,
                currentDurability: durability,
                mainGun: mainGun,
                torpedo: torpedo,
                antiAir: antiAir,
                maxAmmo: ammo,
                currentAmmo: 0, // åˆæœŸå¼¾è–¬0
                reconnaissance: recon,
                accuracyImprovement: accuracy,
                isDispatched: false // æ–°è¦å»ºé€ æ™‚ã¯æ´¾é£ã•ã‚Œã¦ã„ãªã„
            };
let hiyou = (durability * 10000000) + (mainGun * 12000000) + (torpedo * 10000000) + (antiAir * 5000000) + (ammo * 100000) + (recon * 12500000) + (accuracy * 50000000);
            warships.push(newWarship);
            money = money - hiyou;
            logAction(`è»è‰¦ã€Œ${name}ã€ã‚’ (${x},${y}) ã«å»ºé€ ã—ã¾ã—ãŸï¼`);

    } else if (action === 'refuelWarship') { // ç‡ƒæ–™è£œçµ¦
        const warship = warships.find(ship => ship.x === x && ship.y === y);
        if (warship && !warship.isDispatched) {
            const amount = task.amount;
            const cost = amount * 500;
            if (food >= cost) {
                const actualRefuelAmount = Math.min(amount, warship.maxFuel - warship.currentFuel);
                warship.currentFuel += actualRefuelAmount;
                food -= cost;
                logAction(`è»è‰¦ã€Œ${warship.name}ã€ã«ç‡ƒæ–™ã‚’ ${actualRefuelAmount} è£œçµ¦ã—ã¾ã—ãŸã€‚`);
            } else {
                logAction(`è»è‰¦ã€Œ${warship.name}ã€ã¸ã®ç‡ƒæ–™è£œçµ¦ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé£Ÿæ–™ä¸è¶³ï¼‰ã€‚`);
            }
        } else {
            logAction(`(${x},${y}) ã«ã¯è»è‰¦ãŒå­˜åœ¨ã—ãªã„ã‹ã€æ´¾é£ä¸­ã§ã—ãŸã€‚`);
        }
    } else if (action === 'resupplyWarshipAmmo') { // å¼¾è–¬è£œçµ¦
        const warship = warships.find(ship => ship.x === x && ship.y === y);
        if (warship && !warship.isDispatched) {
            const amount = task.amount;
            const cost = amount * 20000;
            if (money >= cost) {
                const actualResupplyAmount = Math.min(amount, warship.maxAmmo - warship.currentAmmo);
                warship.currentAmmo += actualResupplyAmount;
                money -= cost;
                logAction(`è»è‰¦ã€Œ${warship.name}ã€ã«å¼¾è–¬ã‚’ ${actualResupplyAmount} è£œçµ¦ã—ã¾ã—ãŸã€‚`);
            } else {
                logAction(`è»è‰¦ã€Œ${warship.name}ã€ã¸ã®å¼¾è–¬è£œçµ¦ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè³‡é‡‘ä¸è¶³ï¼‰ã€‚`);
            }
        } else {
            logAction(`(${x},${y}) ã«ã¯è»è‰¦ãŒå­˜åœ¨ã—ãªã„ã‹ã€æ´¾é£ä¸­ã§ã—ãŸã€‚`);
        }
    } else if (action === 'dispatchWarship') { // è»è‰¦æ´¾é£ (ã‚­ãƒ¥ãƒ¼ã‹ã‚‰ã®å®Ÿè¡Œ)
        // ã“ã®å‡¦ç†ã¯confirmActionã§ä»–å³¶ã¸ã®è¡Œå‹•ã¨ã—ã¦å‡ºåŠ›æ¸ˆã¿ã®ãŸã‚ã€ã“ã“ã§ã¯ä½•ã‚‚ã›ãšã‚¹ã‚­ãƒƒãƒ—
        // è»è‰¦ã®isDispatchedãƒ•ãƒ©ã‚°ã¨ç‡ƒæ–™0ã¯confirmActionã§æ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹
    } else if (action === 'requestWarshipReturn') { // è»è‰¦å¸°é‚„è¦è«‹ (ã‚­ãƒ¥ãƒ¼ã‹ã‚‰ã®å®Ÿè¡Œ)
        // ã“ã®å‡¦ç†ã‚‚confirmActionã§ä»–å³¶ã¸ã®è¡Œå‹•ã¨ã—ã¦å‡ºåŠ›æ¸ˆã¿ã®ãŸã‚ã€ã“ã“ã§ã¯ä½•ã‚‚ã›ãšã‚¹ã‚­ãƒƒãƒ—
    }
  }
  // actionQueueã¯spliceã§å‡¦ç†æ¸ˆã¿ã®ãŸã‚ã‚¯ãƒªã‚¢ã¯ä¸è¦
  // è»è‰¦ã®ç§»å‹• (æ´¾é£ä¸­ã®è»è‰¦ã¯ç§»å‹•ã—ãªã„)
  for (const warship of warships) {
      if (!warship.isDispatched && warship.currentFuel >= 1) { // æ´¾é£ä¸­ã§ãªã„è»è‰¦ã®ã¿ç§»å‹•
          warship.currentFuel -= 1; // ç‡ƒæ–™æ¶ˆè²»
          const possibleMoves = [];
          for (let dx = -1; dx <= 1; dx++) {
              for (let dy = -1; dy <= 1; dy++) {
                  const nx = warship.x + dx;
                  const ny = warship.y + dy;

                  // è‡ªèº«ã®ç¾åœ¨åœ°ã¯é™¤å¤–
                  if (dx === 0 && dy === 0) continue;

                  // ãƒãƒƒãƒ—ç¯„å›²å†…ã§ã‚ã‚‹ã“ã¨
                  if (nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE) {
                      const targetTile = map[ny][nx];
                      // æµ·ã§ã‚ã‚‹ã“ã¨ã€å»ºç‰©ãŒãªã„ã“ã¨ã€ä»–ã®è»è‰¦ãŒã„ãªã„ã“ã¨
                      const isSeaWithoutFacilityOrWarship = (targetTile.terrain === 'sea' && targetTile.facility === null && !warships.some(otherShip => otherShip !== warship && otherShip.x === nx && otherShip.y === ny));
                      if (isSeaWithoutFacilityOrWarship) {
                          possibleMoves.push({ x: nx, y: ny });
                      }
                  }
              }
          }

          if (possibleMoves.length > 0) {
              const randomIndex = Math.floor(Math.random() * possibleMoves.length);
              const newPos = possibleMoves[randomIndex];
              logAction(`è»è‰¦ã€Œ${warship.name}ã€ã¯ (${warship.x},${warship.y}) ã‹ã‚‰ (${newPos.x},${newPos.y}) ã¸ç§»å‹•ã—ã¾ã—ãŸã€‚`);
              warship.x = newPos.x;
              warship.y = newPos.y;
          } else {
              logAction(`è»è‰¦ã€Œ${warship.name}ã€ã¯ç§»å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆç§»å‹•å¯èƒ½ãªãƒã‚¹ãŒãªã„ï¼‰ã€‚`);
          }
      }
  }

  // ç”Ÿç”£ï¼†æˆé•·å‡¦ç†
  for (let y = 0; y < SIZE; y++) {
    for (let x = 0; x < SIZE; x++) {
      const tile = map[y][x];
      if (tile.facility === 'farm' && tile.terrain === 'plain') {
          foodChange += tile.enhanced ? 300 : 100; // å¼·åŒ–è¾²å ´ã¯é£Ÿæ–™300
      }
      if (tile.facility === 'house') {
        const growth = Math.floor(Math.random() * 151 + 50);
        const added = Math.min(7500 - tile.pop, growth);
        tile.pop += added;
        currentTurnPopulationGrowth += added;
      }
      if (tile.facility === 'factory') {
          moneyChange += Math.floor(population / (tile.enhanced ? 4 / 1.5 : 4)); // å¼·åŒ–å·¥å ´ã¯è³‡é‡‘1.5å€
      }
    }
  }

  // è‡ªå‹•ä½å®…å½¢æˆ
  for (let y = 0; y < SIZE; y++) {
    for (let x = 0; x < SIZE; x++) {
      const tile = map[y][x];
      if (tile.facility === 'farm') {
        for (let dx = -1; dx <= 1; dx++) {
          for (let dy = -1; dy <= 1; dy++) {
            const nx = x + dx, ny = y + dy;
            if (nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE && (dx !== 0 || dy !== 0) && map[ny][nx].terrain === 'plain' && !map[ny][nx].facility && Math.random() < 0.1) {
              map[ny][nx].facility = 'house'; map[ny][nx].pop = 50;
              currentTurnPopulationGrowth += 50;
              logAction(`(${nx},${ny}) ã«ä½å®…ãŒè‡ªå‹•å½¢æˆã•ã‚Œã¾ã—ãŸ`);
            }
          }
        }
      }
    }
  }

  population += currentTurnPopulationGrowth; // åˆè¨ˆã®äººå£å¢—åŠ åˆ†ã‚’åæ˜ 

  foodChange -= Math.floor(population / 200) * 5;
  food += foodChange;
  money += moneyChange;

  // å°é¢¨ã‚¤ãƒ™ãƒ³ãƒˆ
  if (Math.random() < 0.035) { // å°é¢¨ç™ºç”Ÿç¢ºç‡
    logAction(`å³¶ã«å°é¢¨ãŒä¸Šé™¸â€¼`)
    for (let y = 0; y < SIZE; y++) {
      for (let x = 0; x < SIZE; x++) {
        const tile = map[y][x];
        if (tile.facility === 'farm') {
          // é˜²è¡›æ–½è¨­ã«ã‚ˆã‚‹ä¿è­·ã‚’ãƒã‚§ãƒƒã‚¯
          if (getProtectingDefenseFacility(x, y)) { // å¤‰æ›´ç‚¹ï¼šPPå¼¾ä»¥å¤–ã¯å®ˆã‚‹ãŸã‚ã€ã“ã“ã§ã¯PPå¼¾ã§ãªãã¦ã‚‚å®ˆã‚‹
              logAction(`(${x},${y}) ã®è¾²å ´ã¯é˜²è¡›æ–½è¨­ã«ã‚ˆã‚Šå®ˆã‚‰ã‚Œã¾ã—ãŸã€‚`);
              continue;
          }

          let forestCount = 0;
          for (let dx = -1; dx <= 1; dx++) {
            for (let dy = -1; dy <= 1; dy++) {
              const nx = x + dx, ny = y + dy;
              if (nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE && map[ny][nx].terrain === 'forest') {
                forestCount++;
              }
            }
          }
          let destroyChance = (8 - forestCount / 12) / 2; // å°é¢¨ã«ã‚ˆã‚‹è¾²å ´ç ´å£Šç¢ºç‡ã‚’1/2ã«
          if (tile.enhanced) {
              destroyChance /= 2; // å¼·åŒ–è¾²å ´ã¯ã•ã‚‰ã«ç ´å£Šç¢ºç‡ãŒåŠåˆ†
          }

          if (Math.random() < destroyChance / 10) {
            tile.terrain = 'plain';
            tile.facility = null;
            tile.enhanced = false; // æ–½è¨­ç ´å£Šæ™‚ã«å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
            logAction(`(${x},${y})ã®è¾²å ´ã¯å°é¢¨ã«ã‚ˆã‚Šå¹ãé£›ã°ã•ã‚Œã¾ã—ãŸã€‚`);
          }
        }
      }
    }
  }
  // éš•çŸ³ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆ1.8%ï¼‰
  if (Math.random() < 0.018) {
    const x = Math.floor(Math.random() * SIZE);
    const y = Math.floor(Math.random() * SIZE);

    const protectingFacility = getProtectingDefenseFacility(x, y); // å¤‰æ›´ç‚¹

    // éš•çŸ³ã¯PPå¼¾ã«æº–ã˜ã‚‹æ‰±ã„ã¨ã™ã‚‹ï¼ˆé˜²è¡›æ–½è¨­ã‚’ç ´å£Šã—ã¦è²«é€šï¼‰
    if (protectingFacility) {
        protectingFacility.facility = null; // é˜²è¡›æ–½è¨­ã‚’ç ´å£Š
        protectingFacility.terrain = 'waste'; // é˜²è¡›æ–½è¨­ã®å ´æ‰€ã‚’è’åœ°ã«ã™ã‚‹
        protectingFacility.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
        logAction(`(${x},${y}) ã«éš•çŸ³ãŒè½ä¸‹ã—ã¾ã—ãŸãŒã€é˜²è¡›æ–½è¨­ãŒé˜²å¾¡ã«æˆåŠŸã—ã¾ã—ãŸã€‚`);
        logAction(`é˜²è¡›æ–½è¨­ã¯è·å‹™ã‚’å…¨ã†ã—ã¾ã—ãŸã€‚`);
renderMap();
updateStatus();
    }

    const tile = map[y][x];
    const label = tile.facility ? (tile.facility === 'farm' ? 'è¾²å ´' : tile.facility === 'factory' ? 'å·¥å ´' : 'ä½å®…') : tile.terrain;

    // è»è‰¦ã¸ã®ç€å¼¾åˆ¤å®š
    const targetWarship = warships.find(ship => ship.x === x && ship.y === y);
    if (targetWarship) {
        // æ´¾é£ä¸­ã®è»è‰¦ã¸ã®æ”»æ’ƒã¯ç„¡åŠ¹
        if (targetWarship.isDispatched) {
            logAction(`æ´¾é£ä¸­ã®è»è‰¦ã€Œ${targetWarship.name}ã€ã¸ã®éš•çŸ³è¡çªã¯ç„¡åŠ¹ã§ã—ãŸã€‚`);
        } else {
            targetWarship.currentDurability -= 35;
            if (targetWarship.currentDurability <= 0) {
                warships = warships.filter(ship => ship !== targetWarship);
                logAction(`éš•çŸ³ã«ã‚ˆã‚Šè»è‰¦ã€Œ${targetWarship.name}ã€ãŒç •ã‘æ•£ã‚Šã¾ã—ãŸâ€¦`);
            } else {
                logAction(`éš•çŸ³ãŒè»è‰¦ã€Œ${targetWarship.name}ã€ã«å‘½ä¸­ã€ç”šå¤§ãªè¢«å®³ãŒå‡ºã¾ã—ãŸã€‚ (æ®‹ã‚Šè€ä¹…: ${targetWarship.currentDurability})`);
            }
        }
    } else {
        if (tile.facility === 'house') {
            population -= tile.pop;
            if (population < 0) population = 0;
        }

        tile.terrain = 'sea';
        tile.facility = null;
        tile.pop = 0;
        tile.enhanced = false;
        logAction(`å³¶ã«éš•çŸ³ãŒè½ä¸‹â€¼`)
        logAction(`(${x},${y})ã®${label}ã«éš•çŸ³ãŒè½ä¸‹ã—ã¾ã—ãŸã€‚`);
    }
  }
  if (food < 0) {
    logAction(`å³¶ã®é£Ÿæ–™ãŒä¸è¶³ã—ã¦ã„ã¾ã™â€¼`)
    for (let y = 0; y < SIZE; y++) {
      for (let x = 0; x < SIZE; x++) {
        const tile = map[y][x];
        if (tile.facility === 'house') {
          const lost = Math.floor(Math.random() * 201 + 300);
          tile.pop -= lost;
          population -= lost; // äººå£ã‚’å³æ™‚åæ˜ 
          if (population < 0) population = 0;
          if (tile.pop <= 0) {
            tile.terrain = 'waste';
            tile.facility = null;
            tile.pop = 0;
            tile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
            logAction(`(${x},${y})ã®ä½å®…ã¯å»ƒå¢Ÿã¨ãªã‚Šã¾ã—ãŸã€‚`);
          }
        }
      }
    }
    const destroyChance = 0.05;
    if (Math.random() < destroyChance) {
      const allTargets = [];
      for (let y = 0; y < SIZE; y++) {
        for (let x = 0; x < SIZE; x++) {
          const tile = map[y][x];
          if (tile.facility === 'farm' || tile.facility === 'factory') {
            allTargets.push({ x, y });
          }
        }
      }
      if (allTargets.length > 0) {
        const { x, y } = allTargets[Math.floor(Math.random() * allTargets.length)];
        const label = map[y][x].facility === 'farm' ? 'è¾²å ´' : 'å·¥å ´';
        map[y][x].terrain = 'waste';
        map[y][x].facility = null;
        map[y][x].enhanced = false;
        logAction(`(${x},${y})ã®${label}ã§é£Ÿæ–™ä¸è¶³ã«ã‚ˆã‚Šä½æ°‘ãŒæ®ºåˆ°ã€å´©å£Šã—ã¾ã—ãŸã€‚`);
      }
    }
  }
  if (food < 0) food = 0;

  // æ€ªç£å‡ºç¾
  if (!monster && population > 10000 && Math.random() < 0.02) {
    const candidates = [];
    for (let y = 0; y < SIZE; y++) {
      for (let x = 0; x < SIZE; x++) {
        const tile = map[y][x];
        if (tile.facility === 'house') {
          candidates.push({ x, y });
        }
      }
    }
    if (candidates.length > 0) {
      const spawn = candidates[Math.floor(Math.random() * candidates.length)];
      monster = { x: spawn.x, y: spawn.y };

      // æ€ªç£ãŒå‡ºç¾ã—ãŸå ´æ‰€ã®ä½å®…ã‚’ç ´å£Šã—ã€äººå£ã‚’æ¸›ã‚‰ã™
      const spawnedTile = map[spawn.y][spawn.x];
      if (spawnedTile.facility === 'house') {
          population -= spawnedTile.pop;
          if (population < 0) population = 0;
      }
      spawnedTile.terrain = 'waste';
      spawnedTile.facility = null;
      spawnedTile.pop = 0;
      spawnedTile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ

      logAction(`(${spawn.x},${spawn.y}) ã«æ€ªç£ãŒå‡ºç¾â€¼`);
    }
  }

  // æ€ªç£ã®ç§»å‹•ã¨è¢«å®³
  if (monster) {
    const directions = [
      { dx: 0, dy: -1 },
      { dx: 0, dy: 1 },
      { dx: -1, dy: 0 },
      { dx: 1, dy: 0 }
    ];
    const possible = directions.filter(({ dx, dy }) => {
      const nx = monster.x + dx;
      const ny = monster.y + dy;
      return nx >= 0 && ny >= 0 && nx < SIZE && ny < SIZE && map[ny][nx].terrain !== 'sea';
    });

    if (possible.length > 0) {
      const { dx, dy } = possible[Math.floor(Math.random() * possible.length)];
      const nx = monster.x + dx;
      const ny = monster.y + dy;

      const targetTile = map[ny][nx];
      // æ€ªç£ã¯PPå¼¾ã«æº–ã˜ã‚‹æ‰±ã„ã¨ã™ã‚‹ï¼ˆé˜²è¡›æ–½è¨­ã‚’ç ´å£Šã—ã¦è²«é€šï¼‰
      const protectingFacility = getProtectingDefenseFacility(nx, ny);
      if (protectingFacility) {
          protectingFacility.facility = null;
          protectingFacility.terrain = 'waste';
          protectingFacility.enhanced = false;
          logAction(`æ€ªç£ã«ã‚ˆã£ã¦ (${nx},${ny}) ã‚’å®ˆã£ã¦ã„ãŸé˜²è¡›æ–½è¨­ãŒç ´å£Šã•ã‚Œã¾ã—ãŸï¼`);
      }

      if (targetTile.facility === 'house') {
        population -= targetTile.pop;
        if (population < 0) population = 0;
      }
      targetTile.terrain = 'waste';
      targetTile.facility = null;
      targetTile.pop = 0;
      targetTile.enhanced = false; // å¼·åŒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ

      logAction(`æ€ªç£ãŒ (${nx},${ny}) ã‚’è¸ã¿è’ã‚‰ã—ã¾ã—ãŸã€‚`);
      monster.x = nx;
      monster.y = ny;
    }
  }

let gunCount = 0;
let defenseFacilityCount = 0;
let portCount = 0;
// ãƒãƒƒãƒ—ä¸Šã®æ–½è¨­æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
map.forEach(row => {
    row.forEach(tile => {
        if (tile.facility === 'gun') gunCount++;
        else if (tile.facility === 'defenseFacility') defenseFacilityCount++;
        else if (tile.facility === 'port') portCount++;
    });
});
// æ²ˆæ²¡ã—ã¦ã„ãªã„è»è‰¦ï¼ˆcurrentDurability > 0ï¼‰ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
const activeWarshipCount = warships.filter(ship => ship.currentDurability > 0).length;
const facilityMaintenance = (gunCount * 600) + (defenseFacilityCount * 2000) + (portCount * 2500);
const warshipMaintenance = activeWarshipCount * 20000;
const totalMaintenanceCost = facilityMaintenance + warshipMaintenance;
if (totalMaintenanceCost > 0) {
    money -= totalMaintenanceCost;
    logAction(`ç¶­æŒè²» ${totalMaintenanceCost}G ã‚’è³‡é‡‘ã‹ã‚‰å·®ã—å¼•ãã¾ã—ãŸã€‚ï¼ˆç ²å°:${gunCount}ã€é˜²è¡›æ–½è¨­:${defenseFacilityCount}ã€æ¸¯:${portCount}ã€è»è‰¦:${activeWarshipCount}ï¼‰`);
    
    // è³‡é‡‘ãŒãƒã‚¤ãƒŠã‚¹ã«ãªã£ãŸå ´åˆã¯0ã«ç½®ãæ›ãˆã‚‹
    if (money < 0) {
        money = 0;
        logAction('è³‡é‡‘ä¸è¶³ã«ã‚ˆã‚Šç¶­æŒãŒå›°é›£ã«ãªã£ã¦ã„ã¾ã™ï¼');
    }
}

  saveMyIslandState(); // ã‚¿ãƒ¼ãƒ³çµ‚äº†å¾Œã€è‡ªåˆ†ã®å³¶ã®çŠ¶æ…‹ã‚’ä¿å­˜
  updateStatus();
  renderMap();
  const populationChange = population - prevPopulation; // äººå£ã®å¢—æ¸›ã‚’è¨ˆç®—
  logAction(`è³‡é‡‘åå…¥: ${moneyChange - totalMaintenanceCost}G, é£Ÿæ–™: ${foodChange >= 0 ? '+' : ''}${foodChange}, äººå£å¤‰åŒ–: ${populationChange >= 0 ? '+' : ''}${populationChange}`);
}

// ã‚»ãƒ¼ãƒ–æ©Ÿèƒ½
window.saveGame = function() {
    islandName = document.getElementById('islandNameInput').value; // UIã‹ã‚‰åå‰ã‚’å–å¾—
    saveMyIslandState(); // è‡ªåˆ†ã®å³¶ã®æœ€æ–°ã®çŠ¶æ…‹ã‚’ä¿å­˜

    const gameState = {
        map: myIslandState.map,
        money: myIslandState.money,
        food: myIslandState.food,
        population: myIslandState.population,
        turn: myIslandState.turn,
        islandName: myIslandState.islandName,
        monster: myIslandState.monster,
        actionQueue: myIslandState.actionQueue,
        warships: myIslandState.warships // è»è‰¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    };
    const jsonString = JSON.stringify(gameState);

    // æ–‡å­—åˆ—ã‚’Unicodeã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®é…åˆ—ã«å¤‰æ›ã—ã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§çµåˆ
    const encodedData = Array.from(jsonString).map(char => char.charCodeAt(0)).join(',');

    document.getElementById('saveLoadData').value = encodedData;
    logAction("ã‚²ãƒ¼ãƒ ãŒã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦å‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
    updateStatus(); // å³¶ã®åå‰ã®å¤‰æ›´ã‚’UIã«åæ˜ 
}

// ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
window.loadGame = function() {
    const encodedData = document.getElementById('saveLoadData').value;
    if (!encodedData) {
        logAction("ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
        return;
    }

    try {
        // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®æ–‡å­—åˆ—ã‚’Unicodeã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®é…åˆ—ã«æˆ»ã—ã€æ–‡å­—åˆ—ã«å¤‰æ›
        const charCodes = encodedData.split(',').map(Number);
        const jsonString = String.fromCharCode(...charCodes);

        const gameState = JSON.parse(jsonString);

        map = gameState.map;
        money = gameState.money;
        food = gameState.food;
        population = gameState.population;
        turn = gameState.turn;
        islandName = gameState.islandName || "MyIsland";
        monster = gameState.monster;
        actionQueue = gameState.actionQueue || []; // ãƒ­ãƒ¼ãƒ‰æ™‚ã«actionQueueãŒãªã„å ´åˆã«å¯¾å¿œ
        warships = gameState.warships || []; // è»è‰¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰

        // éå»ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã«enhancedãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆã®ãŸã‚ã«åˆæœŸåŒ–
        map.forEach(row => row.forEach(tile => {
            if (tile.enhanced === undefined) {
                tile.enhanced = false;
            }
            if (tile.MonumentLevel === undefined) {
                tile.MonumentLevel = 0;
            }
        }));
        // isDispatchedãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆã®åˆæœŸåŒ–
        warships.forEach(ship => {
            if (ship.isDispatched === undefined) {
                ship.isDispatched = false;
            }
            if (ship.maxFuel === undefined) { // æ—§ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ
                ship.maxFuel = 100;
            }
        });

        document.getElementById('islandNameInput').value = islandName; // UIã«ãƒ­ãƒ¼ãƒ‰ã—ãŸåå‰ã‚’åæ˜ 
        isViewingOtherIsland = false; // ãƒ­ãƒ¼ãƒ‰æ™‚ã¯è‡ªåˆ†ã®å³¶ã«ã„ã‚‹
        saveMyIslandState(); // ãƒ­ãƒ¼ãƒ‰ã—ãŸçŠ¶æ…‹ã‚’è‡ªåˆ†ã®å³¶ã®çŠ¶æ…‹ã¨ã—ã¦ä¿å­˜
        logAction("ã‚²ãƒ¼ãƒ ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚");
        renderMap();
        updateStatus();
        document.getElementById('actionSelect').value = ""; // ã‚³ãƒãƒ³ãƒ‰é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
        updateConfirmButton(); // UIã‚’æ›´æ–°
    } catch (e) {
        logAction("ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã‚‹ã‹ã€å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
        console.error(e);
    }
}

// åˆæœŸåŒ–æ™‚ã«è‡ªåˆ†ã®å³¶ã®çŠ¶æ…‹ã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆã¾ãŸã¯åˆæœŸåŒ–ï¼‰ã™ã‚‹ã€€
window.onload = function() {
    loadMyIslandState(); // ã¾ãšè‡ªåˆ†ã®å³¶ã‚’ãƒ­ãƒ¼ãƒ‰/åˆæœŸåŒ–
    updateConfirmButton(); // åˆå›UIæ›´æ–°
};


</script></body></html>
